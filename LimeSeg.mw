{{Infobox
| software               = Fiji
| name                   = LimeSeg
| logo                   = 
| maintainer             = {{Person|NicolasChiaruttini}}
| author                 = {{Person|NicolasChiaruttini}}, {{Person|SarahMachado}}
| source                 = {{GitHub | org=fiji | repo=LimeSeg}}
| status                 = 
| released               = expected 01/2018
| category               = [[:Category:Segmentation|Segmentation]], [[:Category:Plugins]]
}}

'''A Fiji plugin for the segmentation of 3D objects. '''

Enable the [http://sites.imagej.net/LimeSeg/ LimeSeg update site] (http://sites.imagej.net/LimeSeg/) to get it.


__TOC__

== Publication. ==

TODO / Coming soon.

== Video tutorials ==

Probably the fastest to learn how to use LimeSeg at a basic level. You can find [https://www.youtube.com/playlist?list=PLrEbS8VRQh9qhFYH-9YnVwzMDQBGfCKVj here a playlist containing all the tutorials]. This playlist contains tutorials for:
* [https://www.youtube.com/watch?v=ZAFzMa0eZ0w Single object segmentation]
* [https://www.youtube.com/watch?v=u4BwSHclTMM Multiple objects segmentation]
* [https://www.youtube.com/watch?v=3MtdKeM1xTU Segmentation refinement]
* [https://www.youtube.com/watch?v=3J4RpjE7Gsg Single object segmentation with multiple seeds]
* [https://www.youtube.com/watch?v=GmJA4w9gNO4 An example of a C. Elegans embryo segmentation (one time point)]
* [https://www.youtube.com/watch?v=Ta911ULSWUI Single object segmentation with a pre-defined shape]

== Presentation. ==

LimeSeg is a modular 3D segmentation plugin. It is a particle-based active contour method. It can segment objects from 3D images where 3D objects are labelled on their outline, like cells labeled on their membrane, as shown in the image below (source of the image : https://loci.wisc.edu/sample-data/dub).

[[File:Dub-scaled0.5XY-Tp19.png]]

LimeSeg can be used with simple commands provided by the plugin (under Plugins>LimeSeg in ImageJ menu), or on a more advanced manner with scripting capabilities of ImageJ (macro commands of ImageJ1 or preferentially with [[Groovy_Scripting|groovy scripts]]).

== Commands : basic usage ==


=== Single object segmentation ===
==== Sphere Seg command ====
The command Sphere Seg ('''Plugins>LimeSeg>Sphere Seg''') is the easiest way to use LimeSeg. It allows to segment a 3D object starting from a spherical seed. Here's an example to show how to use it:

1. Open a sample vesicle image. To do this, do '''File>Import>URL..''' and enter the address https://raw.githubusercontent.com/NicoKiaru/TestImages/master/Vesicles/Vesicles.tif

2. Draw a circular ROI that is contained within the vesicle And save it in the ROI manager with the t key or with Edit>Selection>Add To Manager (only this ROI should be contained in the ROI manager).

[[File:LimeSeg_Seed_Vesicle.png]]

3. Execute the Sphere Seg command : '''Plugins>LimeSeg>Sphere Seg'''

4. You need to provide the four most important parameters: 
* '''D_0''': this parameter expressed in numbers of pixels (it can be a real value like 1.2 pixels) is the smallest feature size that you want LimeSeg to detect. A low value (~ 1 pixel) will lead to fine details being detected, at the cost of speed. A too high value will lead to important details being missed. The value is typically between 1 and >20 pixels. (More precisely, D_0 is the equilibrium spacing between the particles used by LimeSeg to delineate the 3D shape.)
* '''F_pressure''' is the "default pressure" exerted on the surface (also called balloon force in related active contour methods). A positive value will lead to expansion of the surface by default, while a negative value will lead to shrinking. Its typical range is [-0.03..0.03]. 
* '''Z_Scale''' is the physical ratio of the spacing between slices (Z spacing) and between pixels (X or Y spacing). The vesicles were imaged with pixels of 133 nm and a z-spacing of 340 nm. Hence this parameter should be set to 340/133 ~ 2.54.
* '''Range in d0 units''' is the size over which each particle will look for a local maximum. A value of 2 with a D_0 of 2 means that a local maximum will be looked for within a layer of 2*2 = [-4..+4] pixels around the surface. Typical values are from 0.5 to >10.
5. Other parameters:
* '''show 3D''' : if checked, displays a 3D view of the segmented objects. For more options, see #ref 3D viewer (TODO).
* '''same cell''': this parameter is not important in this case, since only a single ROI is provided. It will become useful when multiple seeds are needed, see #ref multiple objects (TODO) and #single big objects.
* '''Optimisation steps''' : number of optimization steps. If set to -1, the optimization will take place until convergence is met.
* '''real size XY''' : the size of a XY pixel in physical units. Here a pixel is 133 nm. To get the volume and surface in microns squared and microns cubed units, set this parameter to 0.133.

To segment this demo image, please choose the parameters as in this image:

[[File:LimeSeg_Parameters_Vesicle.png]]

After convergence, you can go through the 2D image and you should see some points along the objects, like this:

[[File:LimeSeg_2DView_Vesicle.png]]

Also the 3D viewer should give a 3D View of the vesicle:

[[File:LimeSeg_3DView_Vesicle.png]]

Other outputs are provided as an ImageJ table:
[[File:LimeSeg_Results_Vesicle.png]]


* '''Cell_Name''' : each 3D object that LimeSeg generated is a "Cell" object. By default, these objects have a String identifier: Cell_0, Cell_1, Cell_2...
* '''Number of Surfels''' : number of surface elements in the generated 3D object. This number is also the number of vertex within the 3D Mesh.
* '''Center X,Y,Z''' : position of the center of mass of the object Vertexes, expressed in pixels for XY, and in slice number for Z (using IJ1 numbering)
* '''Frame''' : frame where the object has been segmented
* '''Channel''' : Channel where the object has been segmented
* '''Mesh?''' : indicates where a mesh has been reconstructed from the object surfels
* ''' Euler characteristic''' : [https://en.wikipedia.org/wiki/Euler_characteristic Euler characteristic] of the reconstructed mesh. This value needs to be 2 for a simply closed surface, 0 for a torus, etc. If its value is not in accordance with your expectations, the surface and volume values will be wrong.
* ''' Free edges''' : Number of free edges of the 3D reconstructed mesh. Should be equal to zero to trust the given surface and volume.
* ''' Surface ''' : Surface of the object in (XY_pixels)^2 units
* ''' Volume ''' : Surface of the object in (XY_pixels)^3 units
* ''' Real Surface ''' : Physical surface of the object
* ''' Real Volume ''' : Physical volume of the object

'''Troubleshooting'''
 
* If the circle ROI is too small, the sphere will disappear immediately -> make a bigger circular ROI.
* If the circle ROI is too big or not fully contained into the  vesicle, the surface could leak outside -> recenter the ROI.
* "the segmentation goes crazy and I'd like to stop it". You can either execute the command '''Plugins>LimeSeg>Stop Optimisation''', or you can set a value different from -1 in the number of optimisation steps parameter (10000 steps is enough for this demo case).

==== Refining a segmentation result ====
It is possible to refine a segmentation by decreasing D_0 after a first roughly defined shape is found. Doing a first segmentation at a high D_0 and then decreasing it by refinement is usually faster than starting the segmentation at a low D_0 value. This can be done after a first segmentation by using the '''Plugins>LimeSeg>Coarsen/Refine''' command.

For instance, in the vesicle example:
1 - Right after the convergence is reached for D_0 = 4, launch the "Plugins>LimeSeg>Coarsen/Refine" command with these parameters: 
Choose the following parameters: D_0_ini = 4; D_0_end = 2; range_in_D_O_units=2.
2 - After the command is finished, you need to resume the segmentation until convergence is newly reached. To do this, execute the command '''Plugins>LimeSeg>Resume Seg'''. You can keep F_pressure to zero, since no bias is required anymore, and set the real size of the pixel as before (0.133).

The shape is now more precise, as you can see in the 2D view and in 3D:

[[File:LimeSeg_2D3DViews_Refined_Vesicle.png]]

==== Alternative ways to segment a single object: multiple spheres and skeletons ====

If the object you want to segment is tortuous or big, starting with a single spherical may not give good results. Here are two alternative ways to segment a single object.

''' Starting with multiple spherical seeds '''

The sample image accessible here: https://raw.githubusercontent.com/NicoKiaru/TestImages/master/ER/ER-FIB-SEM-Small.tif (use '''File>Import>URL''') is a piece of endoplasmic reticulum and is pretty tortuous. While you may get a correct result with one circular ROI as a seed and with the '''Sphere Seg''' command (D_0 = 2 and F_pressure=0.02 gives good results), one can also store several circular ROI in the ROI manager at different places in the piece of ER. Lauching the '''Sphere Seg''' command and checking the '''same Cell''' checkbox will lead to a faster segmentation. When the different seeds meet, they will merge into a single surface.

For instance for three spherical seeds:

[[File:LimeSeg_3D_MultipleSeeds.png]]

Final result:

[[File:LimeSeg_2D3D_ER.png]]

''' Starting with a ROI skeleton'''

It is possible to define more precisely the seeds used to segment images. This can be useful for instance to predefine the structure you want to segment. Let's show how this works through an example, like the segmentation of the contour of the CElegans embryo:

1. Download a 3D C. Elegans embry image ('''File>Import>URL..''') from here: https://raw.githubusercontent.com/NicoKiaru/TestImages/master/CElegans/dub19-half.tif which is a timepoint extracted from the full dataset (https://loci.wisc.edu/software/sample-data).

2. Using a few ROIs approximately define the contour of the embryo at certains slices, like in the image shown above:

[[File:LimeSeg_Skeleton_Example.png]]

You need to begin and end with a single point ROI, otherwise the shape will not be closed. Also, the ROIs need to be drawn clockwise and should starts always at the same angle (start on top for instance).

3. Launch the '''Plugins>LimeSeg>Skeleton Seg''' command, without anything else in the ROI manager. Using the parameters D_0=10, F_pressure = 0, range_in _d0_units=2 and Z_scale=3.5 should give correct results, like shown below:

[[File:LimeSeg_CElegans_Global.png]]

=== Multiple objects segmentation ===

It is possible to segment multiple non overlapping objects with LimeSeg. The most basic way to do this is through the Sphere Seg command. In order too to an example, you can open the test image fo C Elegans with File>Import>URL.. 
This is a timepoint extracted from this dataset:

https://raw.githubusercontent.com/NicoKiaru/TestImages/master/CElegans/dub19-half.tif

Like previously, you can store a single circular ROI in the ROI manager and launch the Sphere Seg command. This set of parameters work nicely:
* D_0 = 4
* F_Pressure = 0.015
* Range_in_D0_units = 1.5
* ZScale=3.5

In this kind of image, you'd probably like to segment multiple cells. You can do this one at a time, but sometimes one segmented surface will leak onto another, because the frontiers are sometimes not well defined. One way to avoid this is to segment multiple cells in parallel and avoid surface overlap. LimeSeg can do this : you can define several seeds defining several objects. In this case, the surfaces will repel each other, a bit resembling watershed methods in that aspect.

You can define multiple seeds (one per cell) simply by storing multiple circular ROIs in the ROI manager. Like in this image:

[[File:LimeSeg-MultiSeeds-SphereSeg.png]]

Of course the seeds can be located at different planes.

You can then launch the '''Plugins>LimeSeg>Sphere Seg''' command with the previously defined parameters, but '''be sure to uncheck the sameCell checkbox''' (otherwise surfaces will merge):

[[File:LimeSeg-MultiSeeds-Param.png]]

You should obtain an image similar to this:

[[File:LimeSeg-MultiSeeds-Output.png]]

If you want to segment the whole embryo, you'll need to provide the location of the cell centers, and then launch the command. The following groovy script will segment the demo image here:

[groovy script]

Providing the result image:

[image]

The colors are chosen randomly and you should be able to vizualize the result both in 2D and 3D, similar to this:
[Images]

The output table also displays the surface and volume of the segmented cells.

=== Others commands ===
==== Cancelling a segmentation result ====
To erase the last launched segmentation command, you can launch the command : '''Plugins > LimeSeg > Cancel Last Optimisation'''

==== Clearing all segmented objects ====
* launch the command : '''Plugins > LimeSeg > Clear all'''
This erases all objects segmented by LimeSeg so far.

==== Stopping a segmentation in progress ====
* Command '''Plugins>LimeSeg>Stop optimization'''

==== Erasing all 3D objects ====
* Command '''Plugins>LimeSeg>Clear all'''

== Graphical user interface ==
The command Plugins>LimeSeg> Show GUI displays LimeSeg GUI. This graphical interface allows to do almost almost everything in LimeSeg, however its structure needs to understand a bit more the core structure of LimeSeg. Each tab provided on the left of LimeSeg correspond to specific actions that will be detailed below, but before the structure of LimeSeg will be developed.

LimeSeg mainly consists of:
* A "State"
* Objects that are segmented
* An Optimizer
* Viewers

The "State" of LimeSeg basically represents on which 3D image LimeSeg is currently working on. It consists of :
1. A working image, which can be set within State>setWorkingImage
2. A current frame, (LimeSeg.currentFrame)
3. A current channel, (LimeSeg.currentChannel)








== 3D Viewer ==
So far LimeSeg provides its own 3D vizualizer. In LimeSeg GUI, several options are available for the 3D Viewer. The 3D view can be moved with arrows, rotated with mouse dragging, and zoomed/unzoomed with the mouse wheel.

* Image synchronization
First of all, the 3D viewer is synchronized with a selected ImageJ image. This image is automatically set by the user selection during a command launch. However, it can also be set with LimeSeg GUI (Plugins>LimeSeg>Show GUI). To select this image, go to the STATE tab, then choose the proper image by clicking on img, then click on "setWorkingImage" button (do not forget this, otherwise the image selection has no effect).

The synchronization occurs since the current slice is highlighted (downlighted...) in the 3D view in synchronization with the selected slice in the 2D view. Also change frame will change the 3D object displayed in case of a multiframe image.

* Other 3D View parameters.
The other parameters can be modified within the 3D View Panel. In LimeSeg GUI, the command is executed once the user clicks on the left most button. The other text area are parameters that should be specified before clicking the command button.
** set3DViewMode If the parameter is 0, all the volumes of the 3D objects are displayed, like this:
1 : the objects are cropped at the position of zposition (cut above)
2 : (cut below)
3 : only the current slice is displayed (cut above and below).
8 : If an optimization is occuring, the optimized dots are displayed (green, dots which have converged, red, dots which have not converged).

== 3D objects handling in LimeSeg ==

Each time a command is performed which is generating objects, these objects are stored within a global array variable (LimeSeg.allCells). Manipulation of these objects with LimeSeg commands is very basic (they can all be erased with clear all command, or the last created objects can be erased with the cancel last optimization command).

It is possible to manipulate these objects with two methods : with LimeSeg GUI or with imageJ scripting.

1 - Manipulating 3D Objects with LimeSeg GUI

First of all, open LimeSeg GUI (Plugins>LimeSeg>Show GUI). You can then vizualize all the 3D objects created by clickling on the show Table button in the STATE tab. If you have created several objects, they should appear in the tab. 

[TODO]

== Opening / Saving / Exporting LimeSeg objects ==
[TODO]

== Groovy scripting : advanced usage ==

[TODO]
