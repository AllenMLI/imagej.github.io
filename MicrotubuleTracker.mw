[[Image:newlogo.png|right|320px]]
{{ComponentStats:net.imagej:MTrack}}
== Description ==
MTrack is a tool, which detects, tracks, and measures the behavior of fluorescently labeled
microtubules imaged by TIRF (total internal reflection fluorescence) microscopy. In such an in vitro
reconstitution approach, stabilized, non-dynamic microtubule seeds serve as nucleation points for
dynamically growing microtubules.
MTrack is a tri-modular tool. The first module detects and tracks the growing microtubule ends and
creates trajectories. The second module uses these trajectories to fit models of dynamic behavior
(polymerization and depolymerization velocities, catastrophe and rescue frequencies). The third
module computes statistics such as length and lifetime distributions when analyzing more than one
movie (batch mode).

== Module 1 - Microtubule Detection & Tracking==
A typical data set consists of a single two-dimensional (2d) image of the non-dynamic microtubule
seeds followed by a 2d time-lapse of the dynamically growing microtubules (Note1). The file format
can be any format readable by Fiji/Bioformats (.tif, .nd2, … ). To run the tracker select {{bc|Plugins|MTrack|Tracking}}
The welcome panel will open.

===Choose Mode===
For a first analysis of your data, we suggest using the simple mode, in which we have pre-selected a
number of parameters. In case you are unsatisfied with the outcome of the tracking you can use the
advanced mode to fine-tune settings. When analyzing more than one movie, you can select batch
mode and run many movies simultaneously. However, before running the program in batch mode, you
have to at least run the program once in single or advanced mode to select and save the required
parameters. The following intro is on simple mode, see here for advanced or batch mode.

===Select Movie===

Next, the user selects the movie.
Please note that detection might work better on flat-field corrected images. Optionally, we offer to
approximate a flat-field correction based on the image data itself (Read more about Preprocessing).
For the movie type chooses one of the three supported options:
• Two channel image as hyper stack (both channels in one image)
• Concatenated seed image followed by time-lapse images
• Single channel time-lapse images
Please choose an output file name and directory. The trajectory files will be written as .txt files. By
default trajectories will be saved in the current working directory with the name of the image.
This mode should be used by the user if the Microtubules are not too densely packed in the image. The tracker breaks down the operation of tracking the dynamic Microtubule ends into a series of short steps the user has to take. The first step is to select an output filename for their tracks and choose the directory to store these tracks in. The track files are written in TXT format in the current working directory and by default it has the name of the image that is currently being analyzed.

Tracking requires an object recognition method to locate the object of interest in the image, in our case the object of interest are the Microtubules and the default algorithms to locate them on the image is Maximally Stable Extremal Regions (MSER) [http://www.sciencedirect.com/science/article/pii/S0262885604000435]. MSER is computed on a unsignedByteType image (Intensity levels between 0-255 ) and the following table explains the MSER parameters to be chosen in this mode.

{| border="1" style="border-collapse:collapse;"
| style="padding: 5px;" | Grey Level Separation
| style="padding: 5px;" | Difference between succeeding thresholds applied to make the component tree.
|-
| style="padding: 5px;" | Unstability Score
| style="padding: 5px;" | A normalized measure of the lifetime of each component.
|-
| style="padding: 5px;" | Min #of pixels
| style="padding: 5px;" | Minimum number of pixels contained in a stable region.
|}

MSER [https://link.springer.com/chapter/10.1007/978-3-540-88688-4_14] applies successive thresholds and builds a component tree as shown in the Figure below.  If the grey level separation is small (0 - 20) more stable regions will be found, if it is high then only few regions will be found. The lifetime of each component is measured by the unstability score and is normalized between 0 and 1. For values close to 1 many regions will be deemed stable and for values close to 0 only very few extremely stable regions will be found. MSER detected regions as shown as red ellipses. The line along which each of the Microtubules lie is assumed to be the semi-major axis of the MSER ellipse.
Optimization using Gaussian line models is done in order to localize the end points of the seeds.

[[Image:GreyLevel.png|400px]]   The nodes of the tree are vertical boxes and vertical extent of the box shows the grey-level life span of each component.

The user can change the MSER parameters using the adjustable sliders and see the effect of their selection on the image. Once the Microtubules are recognized by the algorithm click on "Find endpoints" to obtain the end-points of the Microtubules on the image with sub-pixel accuracy. The found end points will be shown as green circles on the image.

[[Image:SimpleStep1.png|350px]]
[[Image:Mserdet.png|350px]]
[[Image:Mserseeddet.png|350px]]

The program gets all of the seed ends correctly except the seeds that overlap and appear to be inseparable, as shown in the example image above.

=== Advanced Mode ===
In this mode apart from making result filename and directory selection the user also has several options of choosing their method of object recognition and seed end determination. These methods include Distance transform based watershedding followed by Hough Transform to determine the line parameters along which the seeds lie, MSER detection and a combination of MSER and Hough Transform to determine the above mentioned line parameters. 

[[Image:AdvancedMode1.png|500px]]

In order to enhance the Microtubule image pixels a Canny edge detection followed by a mean filter with the radius determined by the SigmaX and SigmaY of the PSF of the microscope is used. The radius factor is a factor multiplying that radius and is user adjustable, in the simple mode this factor is 1 and is adjustable here. Increasing this parameter causes the MSER elliptical region to increase in size while decreasing it has the reverse effect.

Advanced mode comes with three object recognition algorithms namely MSER, Watershed followed by line-Hough transform and MSER followed by line-Hough transform. 
Watershed based object recognition is a method of choice for dense seed images, watershedding allows demarcation of close lying seeds, something that is not possible with MSER. Once the regions in which the Microtubules lie is determined, Line based Hough transform is performed to determine the line parameters of the Microtubules. This is needed to make an initial guess for the optimizer which then fits a Gaussian line model to localize the end points of the Microtubules.
The drawback of watershed based method is the speed of performing Hough transform in each watershed label followed by optimization using Gaussian Line models which is immensely faster in MSER based methods, which however should be the method of choice when the Microtubules are sparsely distributed in the image. 

If the user selects watershed followed by Hough transform the following panel would be displayed:

[[Image:AdvancedMode2Hough.png|500px]] 

Adjustable sliders here include:

A) Threshold value to be used to create a binary image to perform watershedding. 
B) Size of pixel Hough space in relation to the size of pixel in image space. Value of 1 implies same size as in pixel space a value less than 1 implies a bigger Hough space making the detection more accurate, however too small values may not lead to an increase in accuracy, a value between 0.5 and 1 is recommended.

Also after the user makes a selection for the threshold value to be used, they can display the Bitimage and also the watershed image to see if the image was not over or under segmented. To display the watershed image properly the user may have to adjust the brightness and contrast of that image. To do so click {{bc | Image | Adjust | Brightness/Contrast}} and click Auto. If the image is properly segmented the watershed labels displayed should correspond roughly to the number of the Microtubules in the image, after this the user can click on find endpoint to localize Microtubule endpoints.

If the user selects MSER method the following panel is displayed:

[[Image:AdvancedMode2mser.png|500px]]

MSER based object recognition are fast methods to locate and localize the seed ends, but should only be used for sparsely populated Microtubule images as mentioned before. The Microtubules lie along the semi-major axis of the MSER ellipse. Following which the optimization using the Gaussian line models is done to localize the seed ends.

It may happen that some of the Microtubules do not lie along the major axis of the ellipse, in which case the user has to select the method of MSERwHOUGH, in this method Hough transform is performed inside each of the MSER ellipses to determine the required axis, followed by optimization using the Gaussian line models to localize seed ends. In this selection the following panel appears with the user having to select a combination of parameters from above two methods.

[[Image:AdvancedMode2MH.png|500px]]

As an example we take an actual double channel image and detect it's seed ends using MSER and Watershed based Hough transform are shown. Also shown is the watershed image obtained by using a certain threshold value which demarcates certain seeds wrongly, this effect is due to the non-uniform labelling density of the fluorophores across the Microtubule which at a certain threshold level appear as two different Microtubules. In this example watershed based Hough transform gets it wrong and MSER based methods get the seed ends correctly.

[[Image:Seeds.png|400px]]
[[Image:seedwater.jpg|400px]]
[[Image:seeddethough.png|400px]]

In the next example we choose dense seed image and show that watershed based Hough transform is able to demarcate close lying seeds and obtain the correct end points whereas MSER gets some of the close lying seeds wrong as it identifies them as a single Microtubule. For such dense images Watershed based Hough transform is the method of choice with an appropriately chosen threshold value to obtain the watershed image.

[[Image:MSERwrong.png|400px]]
[[Image:seedwaterright.jpg|400px]]
[[Image:waterright.png|400px]]

==  Tracking the growing ends (Module 1)  ==

After the user has obtained the seed ends, the next step is to track the growth emanating from the ends. At this stage the user can make a choice of deselecting some ends they do not want to be tracked or mark the random nucleated ends which they want to be tracked. To do so the user should first ascertain the time-point in the image they want to navigate to make such a selection, it can be the immediate time-point after the seed image or any other. This step is however optional, if the user does not want to make such a selection they can simply skip it and click on confirm seed ends in the panel. In the simple and advanced mode the panel for making this selection appears as:

[[Image:SimpleMode2.png|500px]] [[Image:AdvancedMode3.png|500px]]

A) For the user to select or deselect seed ends from which the growth has to be tracked (optional) in simple and advanced mode.

B) In the simple mode the user can select the start and the end time over which the tracking has to be performed, by default the Microtubule growth is tracked from the first image in the dynamic channel till the last one. This option appears in the advanced mode in the next panel.

C) The user can either do only MSER segmentation at each time point or has the option of doing it after doing a Watershed based segmentation to demarcate close lying Microtubules. In the simple mode only MSER segmentation is performed. In the video tutorial [See the tutorial here: https://youtu.be/DWlMKIQyDQU] the user can make themselves familiar with using the advanced mode features to correctly handle colliding Microtubules.

In the example images below we show the implication of the user deselecting some seed ends from which they do not wish to track the growth. By doing a left click the green ends are deselected and become pink, if some end was deselected by mistake a shift+left click can reselect it. If the user wishes to make a selection that is not a detection by the program an alt+shift+left click would mark a user selected seed in orange. After the user confirms the selection MSER ellipses around the seeds to be tracked will always be marked yellow and other stable regions will be marked red.

[[Image:Deselect.png|400px]] [[Image:Confirm.png|400px]]

=== Visual feedback during tracking ===
After confirming the seed ends the user can select certain optimization options as per their discretion or leave them unchanged and start the tracking. During tracking the the user would see the program detecting the Microtubules each frame and for the seed ends that were marked to be tracked would appear inside yellow MSER ellipses and a crosshair showing the current detected position of the seed end would also be marked. A very fine black line connecting the crosshair across all frames would also be drawn "on the fly". 

[[Image:cross3.png|400px]]

=== End of tracking  ===
At the end of tracking a "Success" frame would appear telling the user that the program has successfully completed the execution. It will also display a final results stack which show the seed ends the program found over frames, a display of actual tracks is also shown superimposed on each Microtubule it tracked.

In the image below we show the tracks of the Microtubule found by the tracker superimposed on the stack of Microtubule image, not all Microtubules were tracked.

[[Image:EndTrack.png|400px]] [[Image:SUM_Stackcollide.png|400px]]


=== Track Videos ===
Here we show two examples of how the end result of the tracker looks like as gif files (click on the image if it does not plays). These files are generated by the tracker at the end of the program and show the regions the program found where the Microtubules were located along with the end points it found over time.

[[Image:resultsexample.gif|400px]] [[Image:CollidingMT.gif|400px]]

== Trajectory analysis using RANSAC (Module 2) ==
The tracker generates TXT files containing co-ordinates, length, per frame incremental length for each frame. Using this information we can obtain the dynamic parameters of the Microtubule. This is the second module of the program. RANSAC is a method to fit a model on the data. The data contains outliers and the model parameters have to be determined by removing these outliers. RANSAC finds the segments which match our model and removes them from further analysis, the procedure stops when the iterative procedure can not find any more segments to fit on the data. RANSAC needs some parameter set which we have as sliders on our interactive tool. When the user wishes to carry out such an analysis they start the RANSAC rate analyzer plugin. The first screen that appears is shown below

[[Image:ransacfile.png|400px]]

For the first time users, select one of the track files for analysis or upload a directory of files as shown above. If the user chooses the second option they will see a list of MTV tracker generated files in a table. They can single click on a file to obtain the length versus time plot along with RANSAC fits using the default parameters. If the default parameters work well user can click on a file and then save the rates and frequencies, which will also appear as a results table. Two results table are displayed, one that contains the start and end time of an event with measured rate for the current working file and other one containing average growth/shrink velocities and catastrophe and rescue frequencies computed from each file.

[[Image:ransacfirst.png|400px]][[Image:resultstableA.png|400px]][[Image:resultstableB.png|400px]]

[[Image:rescueposter.png|500px]]

If the default parameters do not work well, the user can click next and a frame with RANSAC parameter selection options will be shown.

[[Image:RansacSecond.png|500px]]



A) The sliders for determining RANSAC parameters, Max Error is used to distinguish between inliers and outliers for a regularized polynomial fit on the data. Only if the distance of the data points to the polynomial is below this error value will those points be considered as inliers. Min #Points are the minimum time-points that have to be present on a segment. Max Gap is the maximum gap between two segments. 
B) To find the inliers we use a polynomial function and fit it on the data, the linearity fraction can be chosen by the user to make the polynomial a regularized polynomial to find the inliers. Once the inliers have been found a line is fitted onto them within the min and the max value of the slope parameters that can be chosen by the user. As the catastrophes occur very fast the user has to choose a minimum duration in time for an event to be considered a catastrophe. A minimum of three points are needed to fit any function to the data and especially for catastrophes this may not be always the case as shown in the figure below. 

[[Image:catmiss.png|500px]]

The two catastrophes were missed in the left figure as there were not even three timepoints present on which a function could be fit, the plot gives a continuous appearance as it interpolates between missing data but that does not mean that there are actual data points present there.

=== Statistical Analysis (subset module 2) ===
When running in table mode the user would also have the opportunity of obtaining length and lifetime distribution of the Microtubules they analyzed. Once the users have gone through the list of the files to be analyzed and obtained the rates and frequencies, they can click "Compute Length and Lifetime distribution".

The length distribution computes the number of Microtubules having length greater than a certain value, the starting point contains all the Microtubules analyzed by the program as all the Microtubules have length greater than zero. 



[[Image:length.png|500px]]


The life-time distribution computes lifetime for each growth event for each Microtubules, so if a Microtubule had only one growth event the count will be 1, if it had 2 growth events both will be recorded and count at 1 would show its lifetime for first event and count at 2 would show its lifetime for the second growth event and so on.

[[Image:lifetime.png|500px]]

== Batch Modes ==

Both modules of the tracker come with batch modes. For module 1 a parallel batch mode analyzer option exists. To analyze your videos in batch mode select run in batch mode after you have saved the parameters by running in a serial mode before. Start the tracker by selecting: {{bc | Plugins | MTV Tracker | Microtubule Velocity Tracker (Double Channel)}} (for double channel images) and click "Run in Batch Mode", the following screen appears:

[[Image:batchmode.png|500px]]

The user should make a directory of the tif files to be batch processed and select that with the above button. After this the program will start a parallel run of the files, the number of files processed in parallel is equal to the number of the CPU cores of the computer. As a first step it preprocesses each file internally so this step can take a while. At this moment it shows Progress bar for each file it is currently pre-processing. After the pre-processing is over the images are displayed with the same visual feedback as in the serial modes. 

As an example we made a directory containing 4 TIF files and batch processed them in parallel, the following image shows the visual feedback the user would get in such a case. This mode runs without user intervention and user can zoom into the images anytime.

[[Image:parallel.png|800px]]

Batch mode also exists for the second module of the program, to use this mode the user has to save the parameters for RANSAC after running it on single file or on a batch of files.  Then if the user selects "Run in Batch Mode" in the Ransac part of the tracker the following window opens:

[[Image:ransacbatch.png|500px]]

Once the user selects the directory of MTV tracker generated TXT files, the program will do Ransac fits on its own and generate the length and lifetime distribution as well.
