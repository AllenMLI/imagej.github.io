= 4. Intensity vs Time analysis =
== 4.1 Brightness and Contrast ==
[[File:brightness_contrast_pic.png|thumb|right]]
To improve the visualisation of the image, the displayed brightness and contrast can be adjusted with “''Image/Adjust/Brightness/Contrast...''” (hotkey: Shift+C).

The “''Auto”''&nbsp;applies an intelligent contrast stretch to the&nbsp;''way in which the image is displayed''. The brightness and contrast is adjusted based on an analysis of the image's (or selection’s) histogram. If pressed repeatedly, it allows a progressively increasing percentage of pixels to become saturated.

''Reset''&nbsp;changes the “maximum” and “minimum” back to 0 and 255 for 8-bit images and back to the maximum and minimum of the image’s histogram for 16-bit images.

If&nbsp;''Auto''&nbsp;does not produce a desirable result, select a region of the cell plus some background with a region-of-interest (ROI) tool, then hit the “''Auto''” button again. It will then do a stretch based on the intensities within the ROI.

'''Pressing the&nbsp;''Apply''&nbsp;button permanently changes the&nbsp;''actual&nbsp;''grey values of the image. Don’t press this button during while analysing image intensity!'''

If you prefer the image to be displayed as “black on white” rather than “white on black”, the image display can be “inverted” by the command “''Image/Lookup Tables/Invert LUT''”. The command “''Edit/Invert''” inverts the pixel&nbsp;''values''&nbsp;not just the way the image is displayed.

== 4.2 Getting intensity values from single ROI ==
If the movie has been opened as a stack, the ROI selected can be analysed with the command: “''Image/Stacks/Plot Z Axis Profile''”. This generates a single column of numbers - one slice intensity per row.

The top 6 rows of the column are details of the ROI. This is useful to ensure the same ROI isn’t analysed twice and allow relocation of any interesting ROIs. The details are comprised of area, x-coordinate, y-coordinate, AR, roundness, and solidity of the ROI. If the ROI is a polyline/freehand ROI rather than a square/oval, the details are given as if the ROI was an oval/square. The (oval) ROI can be restored by entering the details prompted by the “''Edit/Selection/Restore Selection''”&nbsp;(hotkey: “Ctrl + Shift + E”) command.

The results are displayed in a plot-window with the ROI details in the plot window title. The plot contains the buttons&nbsp;''List, Save, Copy.&nbsp;''The&nbsp;''Copy''&nbsp;button copies the data to the clipboard where it can be pasted into a waiting Excel sheet. The settings for the copy button can be found under “''Edit/Options/Profile Plot Options''”. Recommended settings are:&nbsp;''Do not save x-values&nbsp;''(prevents slice number data being pasted into Excel) and&nbsp;''Autoclose''&nbsp;(prevents you having to close analysed plot each time.

== 4.3 Dynamic intensity vs Time analysis ==
The plugin “''Plot Z Axis Profile"&nbsp;''(this is the&nbsp;''Z Profiler'' from Kevin (Gali) Baler (gliblr at yahoo.com) and Wayne Rasband simply renamed)&nbsp;&nbsp;will monitor the intensity of a moving ROI using a particle tracking tool. This tool can be either manual or automatic. Use the “''Image/Stacks/Plot Z Axis Profile''”&nbsp; command.

==  4.4 Getting intensity values from multiple ROIs ==
Multiple ROIs can be analysed at once using Bob Dougherty’s “''Multi Measure''” plugin. There is a native “ROI manager” function which does a similar job except the results generated are not sorted in to columns. Check Bob’s website for updates:&nbsp;[http://www.optinav.com/imagej.html http://www.optinav.com/imagej.html]

The Multi Measure plugin that comes with the installation is v3.2.

1.&nbsp;Open confocal-series. Remove background (See&nbsp;Background correction)

2.&nbsp;It’s worthwhile generating a reference stack to add the ROIs to. Use the “''Image/Stacks/Z-project''” function. Select the “Average” option.

3.&nbsp;Rename this image “Ref&nbsp;''expt name''” or something memorable.

4.&nbsp;Open “''ROI Manager''” plugin (“''Analyze/Tools/Roi Manager''&nbsp;”&nbsp;or toolbar icon&nbsp;).

5.&nbsp;Select ROIs and "''Add''" to ROI manager. Clicking "''Show All''" helps avoid analysing the same cell twice.

6.&nbsp;Once finished selecting ROIs to be analysed in the reference image, you can draw them to the reference image by clicking the "''More>>''" button and selecting&nbsp;''Draw''. Save the reference image to the&nbsp;experiment’s data folder and then select the stack to be analysed by clicking on it.

7.&nbsp;Click "''More>>''" button in the ROI manager and select “''Multi Measure''” button to measure all the ROIs. Click “Ok”. This will put values from each slice in to a single row (multiple columns per slice). Clicking on "''Measure''" will put all values from all slices and each ROI in a&nbsp; single column.

8.&nbsp;Go to “Results” window. Select menu item “''Edit/Select All…''”. Then “''Edit/Copy All''”.

9.&nbsp;Go to Excel and paste data. With large data sets this can take some time so check you’re pasting new data in and not the last dataset copied from Multi Measure.

[[File:roi_manager_results_box.jpg]]10.&nbsp;To copy ROI co-ordinates in to the Excel spreadsheet, ensure there is an empty row above the intensity data. Got to Multi Measure dialog and click “Copy list” button.

14.&nbsp;Go to Excel, select the empty cell above the first data column and then paste the ROI co-ordinates.

The ROIs can be stored and re-opened later using the Multi Measure dialog button “''Save''”. Save them in the experimental data folder. The ROIs can be opened later either individually (Multi Measure dialog button “''Open''”) or all at once (Multi Measure dialog button “''Open All''”) which opens all the ROIs in a folder.

Oval and rectangular ROIs can also be restored individually from x, y, l, h values using “''Plugins/ROI/SpecifyROI…''”.

== 4.5. Ratio Analysis ==
[[File:intensity_ratio_analysis.jpg|right]]
Analysis of dual-channel ratio images requires careful background subtraction prior to analysis. See section&nbsp; '''7.5 Background correction.&nbsp;'''The''"Plugins/Stacks - T-functions/Ratio_Profiler"''&nbsp;plugin will perform ratiometric analysis of a single ROI on a dual-channel interleaved stack, i.e. the odd-slices are channel 1 images, the even slices channel 2. Perkin Elmer&nbsp;''Ultraview''&nbsp;and Leica SP dual channel experiments can be directly imported as an interleaved stack using the menu command "''File/Import/Image Sequence''". If your two channels are opened as separate stacks, e.g. Zeiss, the two channels can be interleaved with the menu command "''Plugins/Stacks - Shuffling/Stack Interleaver''".

The plugin will generate a green-plot of the ratio values (Ch1÷Ch2 by default; Ch2÷Ch1 if the plugin is run with the Alt-key down); a second plot of the intensities of the individual channels (Ch1 and Ch2); and a results table.

The first row of the results table is the x, y, width and height of the ROI.

From the second row downward, the first column is the time&nbsp;or slice number; the second column the Ch1 mean intensity, Ch2 mean intensity and the ratio value. If the stack has its frame interval calibrated, the "Time" value will be in seconds otherwise it is "Slices". The frame interval can be set for the stack via the menu command&nbsp;''"Image/Properties"''&nbsp;dialog.

This table can be copied to the clipboard for pasting to another program by using the "''Edit/Copy All''" menu command.

&nbsp;

'''''4.5.1&nbsp;Ratio Analysis Using ROI manager'''''

1.&nbsp;BG subtract&nbsp;the image.

2. Open&nbsp;''ROI manager''&nbsp;(''Analyze/Tools/ROI manager...'') and click the "Show All" button.

3. Select the cells to be analysed and add to the ROI manager ("Add" button or keyboard 't' key).

4. Run the plugin "''Plugins/Stacks - T-functions/Ratio ROI Manager''".

The results window contains the mean&nbsp; of ch1 and ch2 and their ratio. Each row is a timepoint (slice). The first row contains the ROI details.

To generate a reference image:

1. flatten the stack (''Image/Stacks/Zproject" "Projection type: Maximimum"''),

2. Adjust the&nbsp;brightness and contrast&nbsp;if required.

3. Ensure the new image is selected and click the "More button" in the ROI manager then select "Label".

&nbsp;

&nbsp;

== 4.6 Obtaining timestamp data == 
''NOTE: MAY BE OUT OF DATE''&nbsp;

=== 4.6.1 Zeiss LSM ===
Once imported via the Zeiss LSM panel, the timestamp data can be extracted with the panel’s ‘Apply t-stamp’ button. This will then ask you if you want the timestamp to be added to the image, or displayed in a text file for saving/pasting to excel etc.

=== 4.6.2 Noran ===
In most instances the x-axis data, i.e. time of each frame, can be calculated from acquisition rates and frame number (e.g. frame 301 acquired with the acquisition rate set to 1 frame per 0.5 seconds was acquired at 25 minutes). However, the acquisition rate is non-linear, in the above experiment frame 301 was actually acquired at 25 minutes 12 seconds. Each frame has stored with it a “timestamp”, the precise time (in nanoseconds!) that it was acquired. This information can be extracted from an opened movie.

The movie must be opened as a stack and the timestamps can be extracted with the command: “''Import/Noran timestamp (msec)''”&nbsp;&nbsp;while the Noran Movie is open and selected.&nbsp;The timestamp data appears in the “''Results''” window. To copy data, click with the right mouse button on the windows, select “''Select All''”, then right-click again and select&nbsp;''Copy''. The timestamp data (accompanied by the movie filename) can then be pasted into Excel.

The Noran SGI plugins are not bundled with the ImageJ package. To receive them, please contact[mailto:tonyc@uhnresearch.ca tonyc@uhnresearch.ca]<nowiki>&nbsp;or their author, Greg Joss <gjoss@bio.mq.edu.au>, Dept of Biology, Macquarie University, Sydney, Australia.</nowiki>

=== 4.6.3 Biorad ===
This can be accessed via the menu command “''Image/Show Info…''”. Scroll down and it should give the time at which each slice was acquired. This can be selected, copied in to Excel and the time number obtained by searching and replacing (Excel menu command “''Edit/Replace''”) the text, leaving only the time data. The “elapsed” time can then be calculated by subtracting row 1 from all subsequent rows.

== 4.7 Pseudo-linescan ==
“Linescanning” is a mode of acquisition common to many confocal microscopes where a single pixel wide line is acquired over a period of time instead of the norma1 2-D, x-y image. Usually this allows faster acquisition. The single pixel wide images over the time course are stacked from left to right to generate a 2-D image (i,e,&nbsp;''x''-''t'').

A “pseudo-linescan” is the generation of a linescan-type x-t plot from a 3-D (''x, y, t'')&nbsp;timecourse and can be useful in displaying 3-D data (x, y, t) in 2 dimensions.

A line of interest must be drawn followed by the command: “''Image/Stacks/Reslice”''&nbsp;or keyboard “/”. It will prompt for the line width. Enter the width of line you wish to be averaged. A pseudo-linescan “stack” will be generated, each slice representing the pseudo-linescan of a single-pixel wide line along the line of interest. To average the pseudo-linescan “stack”, select “''Image/Stack/Z-Project…''” and select the&nbsp;''Average''&nbsp;command. A polyline can be used although this will only allow a single pixel slice to be made.

This example shows the elementary calcium events preceding a calcium wave. HeLa cell loaded with the calcium-sensitive fluorophore, Fluo-3 and imaged whilst responding to application of histamine.&nbsp;'''A'''. Frame taken from time-course at the peak of the calcium-release response. ('''B''') The line of pixels along X-Y was taken and stacked side by side from right-to left to generate a "pseudo-line scan". This allows visualisation of the progression of the wave from its initiation site.


&nbsp;ImageJ assumes stacks to be&nbsp;''z''-series rather than&nbsp;''t''-series so many functions related to the third-dimension of an image stack are called “''z-”''&nbsp;something – e.g. “z-axis profile” is intensity over time plot.

== 4.8 FRAP Analysis ==
The FRAP profiler plugin will analyse the intensity of a beached ROI over time and normalise this against the intensity of the whole cell. It will then find the minimum intensity in the bleach ROI and fit the recovery&nbsp; from this point.

To use:

1. Open the&nbsp;ROI manager.

2. Draw around the bleached ROI and Add to the ROI manager.

3. Draw around the whole cell and add to ROI manager. The normalisation corrects for the bleaching dues to image acquisition and assumes the whole cell is in the field of view.

'''The plugin assumes the larger of the last two ROIs in the ROI manager is the whole cell ROI and the smaller the bleached ROI.'''

4. Run the FRAP profiler plugin.

5. The plugin will return the intensity vs time plot; the normalised intensity vs time plot of the bleached area and the curve fit.

The normalisation corrects for the bleaching dues to image acquisition and assumes the whole cell is in the field of view.

'''normalised intensity at time t = It&nbsp;<nowiki>= (Ib</nowiki>t&nbsp;÷ Ibmax)&nbsp; ÷ (Ict&nbsp;÷ Icmax)'''

'''Ibt<nowiki>= intensity of bleached ROI at time t.</nowiki>'''

'''Ict<nowiki>= intensity of whole cell at time t.</nowiki>'''

== 4.9 Non-linear contrast stretching ==
=== 4.9.1 Equalization ===

{| style="border-spacing:0;"
| style="border:none;padding:0in;"| More control of the brightness and contrast adjustment can be achieved with the“''Process/Enhance contrast”''&nbsp;menu command. Here, when applied to a stack, it applies the adjustment based on each slice’s histogram, not just the one currently displayed as is done with the&nbsp;''Brightness and Contrast&nbsp;''window.

“Equalize contrast” applies a non-linear stretch of the histogram based on the square root of the intensity (see online guide to image processing: [http://www.dai.ed.ac.uk/HIPR2/histeq.htm http://www.dai.ed.ac.uk/HIPR2/histeq.htm]).

|}
[[File:equalize_histrogram.jpg]]

=== 4.9.2 Gamma ===
<nowiki>This can be though of as a non-linear histogram adjustment. Faint objects can be made more intense without saturating bright objects (gamma <1). Similarly, medium-intensity objects can be made fainter without dimming the bright objects (gamma > 1). The intensity of each pixel is “raised to the power” of the gamma value and then scaled to 8-bits or the min and max of 16-bit images.</nowiki>

For 8 bit images; New intensity = 255 ×&nbsp;''<nowiki>[(old intensity÷255)</nowiki>&nbsp;gamma'']

Gamma can be adjusted via the “''Process/Math/Gamma”''&nbsp;command or the “''Plugins/Utilities/Gamma Scroll-bar''”&nbsp;plugin. The latter will open up a new window copy of your image and you can adjust the gamma with the scroll bar. Click on “''Done”''&nbsp;when you are finished. This is a bit flaky and doesn’t react well if you change images in mid-adjust! You can use the Scroll-bar to determine the desired gamma value on one slice of your stack, and then apply this gamma value to the stack via the “''Process/Math/Gamma”''&nbsp;command. [[File:gamma_pic.jpg]]

== 4.10 Filtering ==
See the online reference:&nbsp;[http://www.dai.ed.ac.uk/HIPR2/filtops.htm http://www.dai.ed.ac.uk/HIPR2/filtops.htm]&nbsp;for a simple explanation of digital filtering.

Filters can be found under the menu item “''Process/Filters...''”''.''&nbsp;Typically use a “''Radius (pixels)''” of 1 which equates to a 3×3 “kernel” – see online reference.

''Mean filter'': the pixel is replaced with the average of it and its neighbours within the radius. The menu item “''Process/Smooth''” is a 3×3 mean filter.

''Gaussian filter'': The is similar to smoothing but replaces the pixel with a pixel of value proportional to a normal distribution of it’s neighbours – not explained well, I know, but you’ve probably skipped the online reference and you need to read that to understand the way the filter works properly.

''Median filter'': the pixel is replaced with the median of it and its adjacent neighbours. This removes noise and&nbsp;''preserves boundaries''&nbsp;better than simple mean filtering, but can look odd. (The menu item “''Process/Noise/Despeckle''” is a 3×3 median filter).

''Kalman filter''&nbsp;: Sophisticated filtering for time-course experiments – a sort of “weighted running average”. Best used if the sample frequency is higher than the “event” frequency i.e. slowly occurring events. Otherwise you get odd, blurry results. “''Process/Filter/Kalman Stack…”.''

''Sigma filter'': A modification on the standard mean filter but preserves edges better – can be though of as a “gentle smooth”. The user specifies the kernel size, the Sigma width and the minimum number of pixels to include. A&nbsp;''Sigma''&nbsp;value for the kernel is calculated (based on the variance and mean of the intensities) and only pixels within this&nbsp;''Sigma range''&nbsp;(=&nbsp;''Sigma''&nbsp;× the user defined&nbsp;''Sigma Width&nbsp;''scaling factor) are used to calculate the mean. If there are too few pixels (exact number set in the user dialog:''Minimum number of pixels'') in the kernel that are within the Sigma range then the central pixel which is assumed to be spuriously low or high and the mean of the rest of the kernel is taken. Increasing the''Sigma width''&nbsp;and the&nbsp;''minimum number of pixels''&nbsp;results in increased smoothing and loss of edges.

''Anisotropic Diffusion.''&nbsp;This is an edge preserving smoothing filter.

[[File:anisotropic_diffusion_filter.jpg]]&nbsp;

== 4.11 Background correction ==
Background correction can be done in several ways and is facilitated if the grey image has the “''Image/Lookup Tables/HiLo''” LUT loaded. This displays the zero values blue and the 255 white values red.

If the background is relatively even across the image, it is most simply remove with the ''Brightness/Contrast''&nbsp;command – slowly raise the&nbsp;''Minimum''&nbsp;value until most of the background is displayed blue. The press the&nbsp;''Apply&nbsp;''button to change the grey-values and remove the background.

=== 4.11.1 Rolling-Ball background correction ===
For uneven background the menu command “''Process/Subtract background''” can be used. This menu command removes uneven background from images using a “rolling ball” algorithm. The radius should be set to at least the size of the largest object that is&nbsp;''not''&nbsp;part of the background. It can also be used to remove background from gels where the background is white. Running the command several times may produce better results.



{| style="border-spacing:0;"
| style="border:none;padding:0.0194in;"| &nbsp;'''RAW'''
| style="border:none;padding:0.0194in;"| &nbsp;
| style="border:none;padding:0.0194in;"| “'''''Process/Subtract Background…”'''''

|-
| style="border:none;padding:0.0194in;"| [[File:raw_rolling_ball_back_corr.jpg]]
| style="border:none;padding:0.0194in;"| [[File:rolling_ball_back_corr.jpg]]
| style="border:none;padding:0.0194in;"| [[File:processed_rolling_ball_back_corr.jpg]]

|}
&nbsp;

Once the background has been evened, final adjustments can be made with the&nbsp;''Brightness/Contrast''control.

&nbsp;



{| style="border-spacing:0;"
| style="border:none;padding:0.0194in;"| [[File:bright_contr_roll_ball.jpg]]
| style="border:none;padding:0.0194in;"| [[File:histogram_roll_ball.jpg]]
| style="border:none;padding:0.0194in;"| [[File:bright_contr_control_roll_ball.jpg]]

|}

=== 4.11.2 ROI background correction ===
The rolling-ball algorithm is time consuming. If the background is even across the field of view it is possible to select a background region of interest and subtract the mean value of this area for each slice from each slice. Use the selection tools to select an area of background and run the menu command “''Plugins/ROI/BG Subtraction from ROI”''. This macro will subtract the mean of the ROI from the image plus an additional value equal to the standard deviation of the ROI multiplied by the scaling factor you enter (3 by default).

<nowiki>i.e. it subtracts [mean + (sd×scalingfactor)]</nowiki>

This macro also works with stacks and so can be used with time-courses with varying background.

&nbsp;



{| style="border-spacing:0;"
| style="border:none;padding:0in;"| <center>'''Before correction'''</center>
| style="border:none;padding:0in;"| <center>&nbsp;'''Background intensity over time'''</center>
| style="border:none;padding:0in;"| <center>'''After “''ROI_BG_Correction''”'''</center>

|-
| style="border:none;padding:0in;"| [[Image:image_41.gif]]
| style="border:none;padding:0in;"| [[Image:image_42.gif]]
| style="border:none;padding:0in;"| [[Image:image_43.gif]]

|}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

== 4.12 Flat-field correction ==
=== 4.12.1 Proper correction ===
This technique is applied to brightfield images. Uneven illumination, dirt/dust on lenses can result in a poor quality image. This can be corrected by acquiring a “flat-field” reference image&nbsp;''with the same intensity illumination as the experiment''. The flat field image should, ideally, be a field of view of the coverslip without any cells/debris. This is often not possible with the experimental coverslip, so a fresh coverslip may be used with approximately the same amount of buffer as the experiment. With fixed-specimens try removing the slide completely



{| style="border-spacing:0;"
| colspan="3" | [[Image:image_44.gif]]

|-
|| <center>'''RAW'''</center>
|| <center>'''Flat-field'''</center>
|| <center>&nbsp;'''Processed'''</center>

|}

{| style="border-spacing:0;"
|| [[Image:image_1.jpg]]
|| 1.&nbsp;Open both experimental image and flat-field image.

2.&nbsp;“''Select all''” of the flat-field image (hotkey: A) and measure the average intensity (hotkey: M). This value will appear in the results window and represents your k1 value below.

3.&nbsp;Use the “''Image Calculator plus''” plugin (“''Analyse''/''Tools/Calculator plus''”&nbsp;).

4.&nbsp;i1 = experimental image; i2 = flat-field image; k1 = mean flat-field intensity; k2 = 0. Select the "''Divide"&nbsp;''operation.

This can also be done using the “''Process/Image Calculator”''function and ensuring the “32-bit Result” option is checked. You will then need to adjust the brightness and contrast and change the image to 8-bit.

&nbsp;

|}
=== 4.12.2 Pseudo-correction ===

{| style="border-spacing:0;"
| colspan="2"  style="border:none;padding:0in;"| [[Image:image_3.gif]]Often it is not possible to obtain a flat-field reference image. However, it is still possible to correct for illumination intensity (although not small defects such as dust) by making a “pseudo-flat field” image by performing a large-kernel filter on the image to be corrected. This is particularly useful for DIC images where there is an intrinsic, and distracting, gradient in illumination.

The menu command “''Process''/''Filters/Pseudo-flat field''&nbsp;” automates this process. You are prompted to enter the kernel size for the mean filter; try the default value of 50 first. You can opt to keep the flat field image open to check whether the kernel is large enough. The objects should not be visible in the flat field image.

This can also be used with stacks for brightfield time-courses that vary in intensity with time. This is time consuming though.

|-
| style="border:none;padding:0in;"| [[Image:image_4.gif]]
| style="border:none;padding:0in;"| The first RAW image (top) pseudo-flat field corrected. Here the pseudo-flat field corrects for the uneven illumination but does not correct the dust specks. Compare this with the result of a proper flat-field correction above.

|}
&nbsp;

=== 4.12.3 FFT background correction ===
We sometimes see uneven illumination and also horizontal "scan lines" in transmitted light images acquired with confocal microscopes. This background can be corrected using the native FFT bandpass function (''Process/FFT/Bandpass...).''

Experiment with the settings to optimise the filtering.


&nbsp;

== 4.13 Masking unwanted regions ==
=== 4.13.1 Simple masking ===
Draw around the area you want with one of the ROI tools then use: “''Edit/Clear outside''”''.&nbsp;''This will change area outside the selected region to the background value.

&nbsp;

=== 4.13.2 Complex masking ===
A more sophisticated masking can be done by “thresholding” the image and subtracting this new binary image from the original.

1.&nbsp;Duplicate the image (if it’s a stack it’s worthwhile generating a “average projection” of a few frames).

2.&nbsp;Threshold this image using the menu command “''Image/Adjust/Threshold''” (hotkey Shift+T).

3.&nbsp;Hit the Auto button and then adjust the sliders until cells are all highlighted red.

4.&nbsp;Then click “''Apply''”. Check the tick box: “black foreground, white background”. You should now have a white and black image with your cells black and background white. If you have white cells and black background, invert the image with “''Edit/Invert''”.

5.&nbsp;This can be smoothed (“''Process/Smooth''”) and the black area enlarged slightly with “''Process/Binary/Dilate''” to give a better mask

6.&nbsp;Using the regular Image calculator “''Process/Image calculator''” subtract this black and white “mask” image from your original image/stack.

&nbsp;

&nbsp;

[[Category:Cookbook]]
