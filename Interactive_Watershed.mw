__TOC__

{{Infobox
| software               = ImageJ/Fiji
| name                   = Interactive H-Watershed
| author                 = [[User:Benoit|Benoit Lombardot]]
| maintainer             = [[User:Benoit|Benoit Lombardot]]
| released               = 05 May 2017
| filename               = soon on SCF-MPI-CBG update site
| source                 = https://github.com/mpicbg-scicomp/Interactive-H-Watershed
| category               = [[:Category:Plugins|Plugins]], [[:Category:Segmentation|Segmentation]]
}}

[[Category:Plugins]]
[[Category:Segmentation]]


[[File:InteractiveWatershed_illustration.PNG|center|500px]]
<div align="center">'''Figure 1''' Illustration of the interactive watershed plugin. Showing the plugin control panel in from of a segmentation overlaying raw microspy data. The raw data shows a section of a platynereis organism during its early development. Data were acquired by Mette Handberg-Thorsager (Tomancak lab, MPI-CBG, Dresden)</div>


=Introduction=

Watershed [ref Soille] is a common tool to segment objects in an 2D and 3D images. It is relatively fast and can provides understandable and robust results which can be used for image analysis.

Creating a good segmentation however requires some expertise and can be time consuming. One has to determine the right threshold to stop the watershed. Meaningful local extrema have to be selected to initiate the algorithm. And once a result is obtained the segmentation has to be compared to the original data. That process can then be iterated till satisfying parameters are found. That procedure can be very time consuming if not provided with practicle tools, especially when image are large and a single watershed can take minutes.

The interactive Watershed plugin provides an interactive way to explore local minima (maxima) and threshold, updating the resulting watershed on the fly. This is possible by calculating the watershed only once at plugin initialization. Further when Threshold or maxima selection are updated this initial segmentation is reused to generate the new segmentation instantly. In order to ease quality assessment the results directly overlaid to the data.

The 2 following subsection gives additionnal details on watershed working principle and on the strategy used in the plugin for local maxima detection: H-Maxima


==Watershed principle==

If we interpret images as landscapes of hills and valleys, the watershed algorithm gradually flood the valleys starting from their lowest points (the image local minima). When the flooding of two minima meet at a sadle their remain distinct as each minima region is labelled with a distinct value. The flooding is stopped when all the image is flooded. As object don't always covers the whole image a threshold can be set stoping region evolution before the entire flooding. Alternatively the flooding can be started from local maxima. '''Image 2''' shows the flooding of 3 peaks for different value of the treshold parameter.

[[File:Figure_Watershed.PNG|center|800px]]
<div align="center">'''Figure 2''' The figure illustrates the flooding of an image by the watershed algorithm. First row shows the the flooding of a 2D image while 2nd row illustrate the process in a 1D image (section along the red cut in the 1st row). 1st column shows the orginal image. 2nd column show with spot the detection of local minima. Column 3,4,5 show the flooding of the image. If no stopping criteria is used the entire image is flooded.</div>

==H-Maxima amd H-Watershed==

An image local maximum (minimum) is a region in the image for which all neighboring pixels have a lower (higher) value. A lot of maxima in an image are simply cause by noise and are not meaningful. If one can select more significant maxima corresponding to objects They could be used to initiate a watershed segmentation of the these objects.

There exist many different way of detecting local maxima. H-maxima focus on maxima robustness. It has one paramter, H, that can be compared to the intensity of the noise in the image. H-Maxima selects all maxima which are still maxima when there value is decreased by H. When H is increased less maxima are selected but they end being more robust to noise. Image 3 shows the maxima selected in a sample image for different H values.

We call H-Watershed the segmentation obtained by flooding the H-Maxima of an image. Such segmentation has 2 parameters. The Threshold, T, that stops the flooding of the image and the H-maxima robustness, H, that indicate where the flooding is initiated.

File:Figure_HMax_HWatershed_v3.PNG

[[File:Figure_HMax_HWatershed_v3.PNG|center|800px]]
<div align="center">'''Figure 3''' The figure illustrates the detection of H-Maxima for in 2D, 1D and the resulting 2D watershed (repectively row 1, 2 and 3). The 1st column show the original data, whereas column 2, 3 and 4 show the maxima and H-Watershed respectively for H value 0, 10 and 40. The threshold value 100 was used for the H-Watershed on row 3. The image used for the illustration is crop of the blobs image available from Fiji sample image.</div>

=Usage=


==User Interface==

[[File:Figure_IWS_controlPanel.PNG|center|800px]]
<div align="center">'''Figure 4''' shows the user interface of the Interactive Watershed plugin for 2D image (Left) and 3D image (Right). On the top it shows the name of the analyzed image (Red). Below are parameters input, H value (Green), watershed threshold, T,(Blue) and peak Flooding (Orange). Then one can control segmentation display parameter: display style(Light purple) and the image displayed in the background of the segmentation (Yellow). Finally the export button (Lilac) exports a label map corresponding to the current parameter H,T and peak flooding. User interface for 3D images also allow to select the orientation of the plane displayed (Pink). XY, XZ or YZ planes can then be navigated directly with the slider of the image stack.</div>


[[File:Figure_IWS_visualisationMode.PNG|center|800px]]
<div align="center">'''Figure 5''' is illustrating the way the segmentation can be displayed. The second row shows a close up (red region fom the first row). The raw data (1st column) are segmented by the Interactive Watershed plugin and can be displayed as a label map (2nd column), the segments contour overlaid on aw data (column 3), transparent solid segment overlaid on raw data (column 4).</div>


[[File:Figure_IWS_sideViews_v2.PNG|center|800px]]
<div align="center">'''Figure 6'''</div>


[[File:Figure_IWS_customBgImage.PNG|center|800px]]
<div align="center">'''Figure 7'''</div>

==Scripting==

in IJ macro

in Jython

=Methods and Implementation=

principle: Build a Hierarchy of segments that allow to build all H-Watershed without reprocessing the watershed

Cite paper Najman (initial paper, equivalence to hierarchy), Abealez (ultrametric), Lotufo (IFT watershed)


=References=
[ref Soille]

[ref Najman 1996]

[ref Najman 2010]

[ref Arbealez 1996]

[ref Lotufo]
