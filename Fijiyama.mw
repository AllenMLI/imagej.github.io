{{Infobox
| software               = Fiji
| name                   = Fijiyama
| author                 = Romain Fernandez & CÃ©dric Moisy
| maintainer             = Romain Fernandez
| filename               = [[Fijiyama.jar]]
| source                 = {{GitHub|repo=repo_a_mettre}}
| released               = February 11<sup>th</sup>, 2020
| latest version         = February 11<sup>th</sup>, 2020
| status                 = stable, active
| category               = [[:Category:Analysis|Analysis]], [[:Category:Transforms|Transforms]], [[:Category:Registration|Registration]]
}}
Fijiyama (Yet Another Matching and Alignment tool for Fiji) is a tool for registration and alignment of 3d images of the same object, acquired with different imaging tools (MRI, X-rays, Microscopy, Photography, ...) and/or at successive observation timepoints.

==Problem position==
3d images acquired with various imaging devices come with variable orientations and positions and can be hard to analyse. Similarly, when monitoring a tissue during long-lasting experiment, the sample cannot stay in the device during long-lasting monitoring experiment, and the object seems to "move" when switching from an observation time to another. In addition, as different modalities highlights different structures, these images can be very dissimilar. In this situation, structures and phenomenons cross-analysis in the different images can be untractable.

Fijiyama adress these issues helping you to register, align and combine 3d images in a common reference geometry. You can choose this geometry to align object axis with the image axis (X,Y,Z), to ease further visual analyses and figures construction. Once alignment is done, your images are not anymore a sparse set of informations, but a coherent multi-modal multi-time volume that you can explore easily with the ImageJ viewer, wearing different "glasses" (RX, MRI, ...) and changing observation time with one click.

==Contribution over existing tools==
As opposed to existing tools under ImageJ, Fijiyama is not dedicated to a specific scale and imaging device. The generic purpose of the registration algorithms used makes it versatile for various image modalities, including common laboratory images : microscopy, photograph, and medical imaging tools (MRI / X-rays registration). 

To adress the complex task of multi-modal registration, computation is based on Block-matching, an algorithm from the medical field. Other common algorithms are available in the plugin (Itk iconic registration). More about the algorithmic bases of the plugin ? See section "The maths behind", bottom of the page.

Image sympa 1

Image sympa 2

Image sympa 3

==Plugin features==

* Two images registration (training / settings mode)

* N-times / M-modalities 3d series registration (main feature)

* Composition of successives Itk transforms into a single transform

* Transformation of a 3d image (or a 4d / 5d hyperimage) with an Itk transform

===Video demonstration===
See the plugin in action :

{{#widget:YouTube|id=wPEU5TIlsTU|width=480}}

==Getting started with Fijiyama==
===Installation===
Add the plugin to your current Fiji distribution in two steps : 
* Download dependancies, using the Fiji updater (Help/Update/Manage update sites...), and be sure that ImageJ-Itk and ImageScience repositories are activated. Otherwise, activate it, and apply changes.
* Install the plugin : download the packaged plugin [[Fijiyama.jar]] into the "plugins" directory of your current Fiji. Restart Fiji, and look for Fijiyama in the plugins menu.

===Prepare your data===
In order to begin with the training mode, you need :
* Two 3d images of the same object. Use your own data, or the provided example dataset here : [[File : Test_dataset_01_vine_crops.zip]]
* A place to build an empty "Output" directory, that will be used to store the Fijiyama configuration file, the intermediate results (transforms) and the final results (transforms and images). The configuration file (*.fjm) keep a full track of your work. When you save the current registration experiment, the configuration stores successive registration steps and the associated computed files. When restarting later from this point, you can review the whole process, and eventually "undo" one or more actions.

===Training : two image registration===
[[File:Fijiyama_reg_manager.png|350px|thumb|right]]
Start Fijiyama from the "Plugins" menu of ImageJ. Click on "Two images registration", then follow the instructions to set the input images and the output directory. Once the registration manager opens, explore the manager. Read the "tooltips" pop-ups, the contextual help, and explore the menus, until you feel comfortable to begin.

The registration manager window has four parts (top to bottom):
* Log window : a guide to remember last operations, and to understand what the plugin expect from you

* Settings menus and buttons : useful to set the parameters of the future action to run

* Action buttons : the first line (<b>Start</b>, <b>Abort</b>, and <b>Undo</b>) drives the lifecycle of the current action, defined by the menus. <b>Save</b> can be used to "checkpoint" the experiment. <b>Export</b> compute the resulting aligned images, according with the succession of transforms computed. <b>Sos</b> can be used at any time. It opens a contextual help message.

* Actions list : this list stores the past (or future) actions on the registration pathway

===Multimodal time-serie registration===

===Compose transforms===
Chain linear and/or dense transforms is a basis of the plugin for serie processing. This module is a helper module to use this function standalone.
Guessing you already computed :
* the transform T12 that align  Image_1.tif with Image_2.tif
* the transform T23 that align  Image_2.tif with Image_3.tif

You may want to align Image_1 with Image_3 in order to compare the three images altogether. Therefore, applying sucessive transforms produce a blurring effect. In  order to avoid this blur, you may want to combine the two transforms in a single one to apply them in one go.

This module ask the successive transforms to be composed (in the example T12 then T23), and produce the resulting combined transform.

===Apply transform to 3d/4d/5d Image===

This module is a helper function to apply an Itk Transform to an image (3d) or an hyperimage(4d / 5d). In case of hyperimage, the transform is interpreted as a 
3d transform, and is applied to each channel / frame of the hyperimage before they are gathered back in the shape of an hyperimage.

== The maths behind ==
Registration of two images is achieved estimating a geometrical transform that can be applied to an image (the "moving one"), to superimpose it with another image (the "reference" one). 

===Transforms===
The transform has to be chosen in a specific transform family. Below are common transform families used in registration, from the simpler (less parameters) to the tougher (more parameters). Fijiyama includes the ones in bold font, to cover main users needs : 
* Translations
* Rotations
* <b>Rigid transforms</b> (Translation + Rotation)
* <b>Similarities</b> (Rigid + isotropic homothetic factor)
* Linear
* Spline
* <b>Dense vector field</b> (one vector per voxel)

===Optimizers===
The Itk iconic algorithm optimizes iteratively a transform, tracking the superposition improvement using a global similarity measure between the two images.
The Block-Matching algorithm (reference) is an hybrid method : it applies a similarity measure to compare subparts of images to identify correspondances. The correspondance are then used to compute a global transform.

== Citing this work ==
R. Fernandez and C. Moisy, Fijiyama : a versatile registration tool for 3D multimodal time-lapse monitoring of biological tissues in Fiji (under review)

== Software dependancies==
* Itk/SimpleItk : We especially thanks the SimpleItk project, giving Itk functionalities wrapped to the Java world. Thanks to SimpleItk, the ItkTransform class used in Fijiyama is based on Itk, especially the class Transform, extending some of its functionalities. SimpleItk/Itk also provides the Itk iconic registration algorithm.
* ImageScience : Rigid transform and similarity estimation from correspondance points are based on ImageScience and VIBLib


== License ==
This program is '''free software'''; you can redistribute it and/or modify it under the terms of the '''GNU General Public License''' as published by the Free Software Foundation ([http://www.gnu.org/licenses/gpl.txt http://www.gnu.org/licenses/gpl.txt]).

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.  
----
[[Category:Plugins]]
[[Category:Registration]]
[[Category:Citable]]
