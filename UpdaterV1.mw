= Updater V1 technical details =

I'll use this page to document the changes made to the ImageJ Updater in the about to be released version called V1.

== What's different ==
* Added a check whether Java supports the HTTPS certificate of the imagej.net server
* Depending on what's supported, the updater will use HTTPS or HTTP links for the update sites on imagej.net (and throw a warning in case HTTPS is not supported)
* Uploading via HTTPS is working now, both basic and digest authentication supported
* The updater is smarter about updating URLs of official sites (= listed on the list of available update sites) in case they change remotely
* There is an interface to review updates to the URLs of active update sites

== Update Check on Startup [[http://www.plantuml.com/plantuml/uml/ZPFH3fiW68NlVGfUe2-mB4kTOch6r2XisLN3y5yaHJ3uwrv_EDfaRMFS7Pxp_GUEudb6wN4PJO8Q3H0nzHA1P0Ee6t6MT7_jASdXbrmCHhi3lse5vFGfWeNpqPZ91-8Ncxog0HGJTtbu28JQt4GgrEicF9paiNZ1BQpWMnYrxT-2FvvE_wBPXMPVhboq5SslTL7iHSw3MqmVCrcG_55mIx-MLNvbAQVjNgYIzhlN2CTPQJXSnNxi1UcvyGv18VJCAOdQsQFCfgqvpNXepUeivMLTxOVdi89nqt7fd7wZh6xs6mzoXGhmj_Etp5aBwd-E6ZuBAokQA0-RK6W3S-QCYTDFMxruOJWE7K21wP-GxNKwvOn0RHxtxy9vqtNBD3cFJt2wIctaJmETZXTwa7EiiWcYPVTUYGTSl2MYoLDEqy-ClZMFMuyJYXayTr6-_oBlneR7bHVbdJg3xPVH_040 src]]==
* this is the `onEvent` Method of the `DefaultUpdateService` which is called when the ImageJ UI is shown 
<source>                                                                                    
                                                                                                                                                                                                                
     ┌────────────────────┐          ┌───────────────┐          ┌────────┐                                           ┌────────────┐          ┌──────────────┐          ┌──────────────────┐          ┌─────────┐
     │DefaultUpdateService│          │CheckForUpdates│          │UpToDate│                                           │ProtocolUtil│          │AvailableSites│          │PromptUserToUpdate│          │UpdaterUI│
     └─────────┬──────────┘          └───────┬───────┘          └───┬────┘                                           └─────┬──────┘          └──────┬───────┘          └────────┬─────────┘          └────┬────┘
               │             run             │                      │                                                      │                        │                           │                         │     
               │ ───────────────────────────>│                      │                                                      │                        │                           │                         │     
               │                             │                      │                                                      │                        │                           │                         │     
               │                             │       check         ┌┴┐                                                     │                        │                           │                         │     
               │                             │────────────────────>│ │                                                     │                        │                           │                         │     
               │                             │                     │ │                                                     │                        │                           │                         │     
               │                             │                     │ │────┐                                                │                        │                           │                         │     
               │                             │                     │ │    │ neverRemind                                    │                        │                           │                         │     
               │                             │                     │ │<───┘                                                │                        │                           │                         │     
               │                             │                     │ │                                                     │                        │                           │                         │     
               │                             │  CHECK_TURNED_OFF   │ │                                                     │                        │                           │                         │     
               │                             │<─ ─ ─ ─ ─ ─ ─ ─ ─ ─ │ │                                                     │                        │                           │                         │     
               │                             │                     │ │                                                     │                        │                           │                         │     
               │                             │                     │ │────┐                                                │                        │                           │                         │     
               │                             │                     │ │    │ shouldRemindLater                              │                        │                           │                         │     
               │                             │                     │ │<───┘                                                │                        │                           │                         │     
               │                             │                     │ │                                                     │                        │                           │                         │     
               │                             │    REMIND_LATER     │ │                                                     │                        │                           │                         │     
               │                             │<─ ─ ─ ─ ─ ─ ─ ─ ─ ─ │ │                                                     │                        │                           │                         │     
               │                             │                     │ │                                                     │                        │                           │                         │     
               │                             │                     │ │────┐                                                │                        │                           │                         │     
               │                             │                     │ │    │ canWrite                                       │                        │                           │                         │     
               │                             │                     │ │<───┘                                                │                        │                           │                         │     
               │                             │                     │ │                                                     │                        │                           │                         │     
               │                             │     READ_ONLY       │ │                                                     │                        │                           │                         │     
               │                             │<─ ─ ─ ─ ─ ─ ─ ─ ─ ─ │ │                                                     │                        │                           │                         │     
               │                             │                     │ │                                                     │                        │                           │                         │     
               │                             │                     │ │────┐                                                │                        │                           │                         │     
               │                             │                     │ │    │ isProtectedLocation                            │                        │                           │                         │     
               │                             │                     │ │<───┘                                                │                        │                           │                         │     
               │                             │                     │ │                                                     │                        │                           │                         │     
               │                             │ PROTECTED_LOCATION  │ │                                                     │                        │                           │                         │     
               │                             │<─ ─ ─ ─ ─ ─ ─ ─ ─ ─ │ │                                                     │                        │                           │                         │     
               │                             │                     │ │                                                     │                        │                           │                         │     
               │                             │                     │ │────┐                                                │                        │                           │                         │     
               │                             │                     │ │    │ isDeveloper                                    │                        │                           │                         │     
               │                             │                     │ │<───┘                                                │                        │                           │                         │     
               │                             │                     │ │                                                     │                        │                           │                         │     
               │                             │     DEVELOPER       │ │                                                     │                        │                           │                         │     
               │                             │<─ ─ ─ ─ ─ ─ ─ ─ ─ ─ │ │                                                     │                        │                           │                         │     
               │                             │                     │ │                                                     │                        │                           │                         │     
               │                             │                     │ │────┐                                                │                        │                           │                         │     
               │                             │                     │ │    │ haveNetworkConnection                          │                        │                           │                         │     
               │                             │                     │ │<───┘                                                │                        │                           │                         │     
               │                             │                     │ │                                                     │                        │                           │                         │     
               │                             │      OFFLINE        │ │                                                     │                        │                           │                         │     
               │                             │<─ ─ ─ ─ ─ ─ ─ ─ ─ ─ │ │                            │                        │                        │                           │                         │     
               │                             │                     │ │                            │                        │                        │                           │                         │     
               │                             │                     │ │       create       ┌───────────────┐                │                        │                           │                         │     
               │                             │                     │ │ ──────────────────>│FilesCollection│                │                        │                           │                         │     
               │                             │                     │ │                    └───────┬───────┘                │                        │                           │                         │     
               │                             │                     │ │            read            │                        │                        │                           │                         │     
               │                             │                     │ │ ──────────────────────────>│                        │                        │                           │                         │     
               │                             │                     │ │                            │                        │                        │                           │                         │     
               │                             │                     │ │                  checkHTTPSSupport                  │                        │                           │                         │     
               │                             │                     │ │ ────────────────────────────────────────────────────>                        │                           │                         │     
               │                             │                     │ │                            │                        │                        │                           │                         │     
               │                             │                     │ │                            hasUpdateSiteURLUpdates  │                        │                           │                         │     
               │                             │                     │ │ ─────────────────────────────────────────────────────────────────────────────>                           │                         │     
               │                             │                     └┬┘                            │                        │                        │                           │                         │     
               │                             │     UPDATEABLE       │                             │                        │                        │                           │                         │     
               │                             │<─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─│                             │                        │                        │                           │                         │     
               │                             │                      │                             │                        │                        │                           │                         │     
               │                             │                      │                             │          run           │                        │                           │                         │     
               │                             │──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────>                         │     
               │                             │                      │                             │                        │                        │                           │                         │     
               │                             │                      │                             │                        │                        │                           │           run           │     
               │                             │                      │                             │                        │                        │                           │ ───────────────────────>│     
     ┌─────────┴──────────┐          ┌───────┴───────┐          ┌───┴────┐                ┌───────┴───────┐          ┌─────┴──────┐          ┌──────┴───────┐          ┌────────┴─────────┐          ┌────┴────┐
     │DefaultUpdateService│          │CheckForUpdates│          │UpToDate│                │FilesCollection│          │ProtocolUtil│          │AvailableSites│          │PromptUserToUpdate│          │UpdaterUI│
     └────────────────────┘          └───────────────┘          └────────┘                └───────────────┘          └────────────┘          └──────────────┘          └──────────────────┘          └─────────┘
</source>

=== ImageJUpdater implements UpdaterUI [[http://www.plantuml.com/plantuml/uml/bLHDRzim3BtxL-Yu0TaVs66eqQ9OXc8hcdftJQ9JejG7H3fPz-kdA7MDM6tZtYJolSSd4jG5YquoE6e4XK2jdTx2ZovQBP0KkaZWm0khvr2tLf_u4COUmNvkJl5Vliq4lYeE3bHC49Lv0FF8ZKcGK-eQ2VWo484H3BuIcWEor94v2Zn3hvDsKB5FiXDrGH59JpT1M_JRANnQSeDPQKxCMbEsyjeE4bm-sExkvWXh9dJcre3tJD-c8C44wWGfmqfVlz_VtsusGumXoVcXx7No2dk5di4C2Mf6kzD8-WyLXvmfFVxj65AvZWQQ6UgjXp38JzXtYHRKGO-2cl0VjDwsrfRuh53LRUoLX_rgxDX2MvaL4p1uMKqMnv7TmGvXVn385Bv2JM5RstyDDKtkjUnxJJgUsnXJs87z6DqY6vq-I7e4YB_e45em6HqZFPNBYmGlRNNXhlkNfzMWQgOCSWMz7aWoPidc9g2WxHHglRqiNyxWpc_4W_QMe2m6-Yslb0c-9pJ2P_yM1lcDZBa7pGLuEpZw3m00 src]] ===
* called from startup in case there are updates available (see last line in previous diagram)
* called via Help > Update...
<code>                                                                                                                                                                                                             
     ┌─────────────┐                                                                                                                       ┌────────────┐          ┌──────────────┐                                
     │ImageJUpdater│                                                                                                                       │ProtocolUtil│          │AvailableSites│                                
     └──────┬──────┘                                                                                                                       └─────┬──────┘          └──────┬───────┘                                
            ────┐                                                                                                                                │                        │                                        
                │ some prep checks                                                                                                               │                        │                                        
            <───┘                           │                                                                                                    │                        │                                        
            │                               │                                                                                                    │                        │                                        
            │       create          ┌───────────────┐                                                                                            │                        │                                        
            │─────────────────────> │FilesCollection│                │                                                                           │                        │                                        
            │                       └───────┬───────┘                │                                                                           │                        │                                        
            │                     create    │                  ┌────────────┐                                                                    │                        │                                        
            │────────────────────────────────────────────────> │UpdaterFrame│                                                                    │                        │                                        
            │                               │                  └─────┬──────┘                                                                    │                        │                                        
            │     tryLoadingCollection      │                        │                                                                           │                        │                                        
            │──────────────────────────────>│                        │                      │                                                    │                        │                                        
            │                               │                        │                      │                                                    │                        │                                        
            │                               │                 create │                 ┌──────────┐                                              │                        │                                        
            │                               │────────────────────────────────────────> │UpdateSite│                   │                          │                        │                                        
            │                               │                        │                 └────┬─────┘                   │                          │                        │                                        
            │                               │                        │                      │     create     ┌──────────────────┐                │                        │                                        
            │                               │                        │                      │ ──────────────>│AutomatedURLUpdate│                │                        │                                        
            │                               │                        │                      │                └────────┬─────────┘                │                        │                                        
            │                               │                        │checkHTTPSSupport     │                         │                          │                        │                                        
            │───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────>│                        │                                        
            │                               │                        │                      │                         │                          │                        │                                        
            ────┐                           │                        │                      │                         │                          │                        │                                        
                │ warn if insecure          │                        │                      │                         │                          │                        │                                        
            <───┘                           │                        │                      │                         │                          │                        │                                        
            │                               │                        │                      │                         │                          │                        │                                        
            │                               │                        │           fixUserSitesProtocol                 │                          │                        │                                        
            │────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────>│                                        
            │                               │                        │                      │                         │                          │                        │                                        
            │                               │                        │                      │                         │                     setNewUrl                     │                                        
            │                               │                        │                      │                         │ <──────────────────────────────────────────────────                                        
            │                               │                        │                      │                         │                          │                        │                                        
            │                               │                        │          initializeAndAddSites                 │                          │                        │                                        
            │────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────>│                                        
            │                               │                        │                      │                         │                          │                        │                                        
            │                               │                        │                      │                         │      if new, create      │                        │                                        
            │                               │                        │                      │ <────────────────────────────────────────────────────────────────────────────                                        
            │                               │                        │                      │                         │                          │                        │                                        
            │                               │                        │                      │                         │               if present, setNewUrl               │                                        
            │                               │                        │                      │                         │ <──────────────────────────────────────────────────                            │           
            │                               │                        │                      │                         │                          │                        │                            │           
            │                               │                        │                      │    create               │                          │                        │                  ┌────────────────────┐
            │──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────> │ReviewSiteURLsDialog│
            │                               │                        │                      │                         │                          │                        │                  └─────────┬──────────┘
            │                               │                        │                      │                         │                          │     setUpdateApproved  │                            │           
            │                               │                        │                      │                         │ <───────────────────────────────────────────────────────────────────────────────           
            │                               │                        │                      │                         │                          │                        │                            │           
            │                               │                        │                      │                         │                          │          discard       │                            │           
            │                               │                        │                      │                         │ <───────────────────────────────────────────────────────────────────────────────           
            │                               │                        │                      │                         │                          │                        │                            │           
            │                               │                        │                      │                         │                          │        keepOldURL      │                            │           
            │                               │                        │                      │                         │ <───────────────────────────────────────────────────────────────────────────────           
            │                               │                        │                      │                         │                          │                        │                            │           
            │                               │                        │           applySitesURLUpdates                 │                          │                        │                            │           
            │────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────>│                            │           
            │                               │                        │                      │                         │                          │                        │                            │           
            │                               │                        │                      │                         │                  applyIfApproved                  │                            │           
            │                               │                        │                      │                         │ <──────────────────────────────────────────────────                            │           
            │                               │                        │                      │                         │                          │                        │                            │           
            │                               │                        │                      │      setDefaultURL      │                          │                        │                            │           
            │                               │                        │                      │ <────────────────────────                          │                        │                            │           
            │                               │                        │                      │                         │                          │                        │                            │           
            │ reloadCollectionAndChecksum   │                        │                      │                         │                          │                        │                            │           
            │──────────────────────────────>│                        │                      │                         │                          │                        │                            │           
            │                               │                        │                      │                         │                          │                        │                            │           
            ────┐                           │                        │                      │                         │                          │                        │                            │           
                │ handle warnings, conflicts│                        │                      │                         │                          │                        │                            │           
            <───┘                           │                        │                      │                         │                          │                        │                            │           
            │                               │                        │                      │                         │                          │                        │                            │           
            │                      setVisible                        │                      │                         │                          │                        │                            │           
            │───────────────────────────────────────────────────────>│                      │                         │                          │                        │                            │           
     ┌──────┴──────┐                ┌───────┴───────┐          ┌─────┴──────┐          ┌────┴─────┐          ┌────────┴─────────┐          ┌─────┴──────┐          ┌──────┴───────┐          ┌─────────┴──────────┐
     │ImageJUpdater│                │FilesCollection│          │UpdaterFrame│          │UpdateSite│          │AutomatedURLUpdate│          │ProtocolUtil│          │AvailableSites│          │ReviewSiteURLsDialog│
     └─────────────┘                └───────────────┘          └────────────┘          └──────────┘          └──────────────────┘          └────────────┘          └──────────────┘          └────────────────────┘

</code>

=== Manually add update site and edit URL [[http://www.plantuml.com/plantuml/uml/ZOuzpi8m343tdC8Nw0K-VKALg9XW0VK0LcqgIswA6cVWzjGiAUK7njZllRXEXfFbGOE9ASC1OqRLAo0Hv0kXCIGn1em4J6BG7lSGJlCeDO8wzb1jO2VAQJkgScSoHlXplRtRJePkOWyj9Yl38sKx-swy4kVVGtcvzh0hvlB2TJonVUqurF0PiphxCTV_aklVvlwhweccWjOSAGzw0m00 src]] ===
<source>
                                                                                            
     ┌───────────┐          ┌───────────────┐                                               
     │SitesDialog│          │FilesCollection│                                               
     └─────┬─────┘          └───────┬───────┘                                               
           │     addUpdateSite      │                                                       
           │───────────────────────>│                       │                               
           │                        │                       │                               
           │                        │     create       ┌──────────┐                         
           │                        │────────────────> │UpdateSite│                 │       
           │                        │                  └────┬─────┘                 │       
           │                        │                       │     create     ┌─────────────┐
           │                        │                       │ ──────────────>│UpdateSiteURL│
           │                        │                       │                └──────┬──────┘
           │                    setURL                      │                       │       
           │───────────────────────────────────────────────>│                       │       
           │                        │                       │                       │       
           │                        │                       │     setDefaultURL     │       
           │                        │                       │ ─────────────────────>│       
           │                        │                       │                       │       
           │                    getURL                      │                       │       
           │───────────────────────────────────────────────>│                       │       
           │                        │                       │                       │       
           │                        │                       │     getDefaultURL     │       
           │                        │                       │ ─────────────────────>│       
           │                        │                       │                       │       
           │                        │     defaultURL        │                       │       
           │<─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─│       
     ┌─────┴─────┐          ┌───────┴───────┐          ┌────┴─────┐          ┌──────┴──────┐
     │SitesDialog│          │FilesCollection│          │UpdateSite│          │UpdateSiteURL│
     └───────────┘          └───────────────┘          └──────────┘          └─────────────┘

</source>


=== Official update site and edit URL [[http://www.plantuml.com/plantuml/uml/ZOuzpi8m343tdC8Nw0K-VKALg9XW0VK0LcqgIswA6cVWzjGiAUK7njZllRXEXfFbGOE9ASC1OqRLAo0Hv0kXCIGn1em4J6BG7lSGJlCeDO8wzb1jO2VAQJkgScSoHlXplRtRJePkOWyj9Yl38sKx-swy4kVVGtcvzh0hvlB2TJonVUqurF0PiphxCTV_aklVvlwhweccWjOSAGzw0m00 src]] ===
<source>
                                                                                            
     ┌───────────┐          ┌───────────────┐                                               
     │SitesDialog│          │FilesCollection│                                               
     └─────┬─────┘          └───────┬───────┘                                               
           │     addUpdateSite      │                                                       
           │───────────────────────>│                       │                               
           │                        │                       │                               
           │                        │     create       ┌──────────┐                         
           │                        │────────────────> │UpdateSite│                 │       
           │                        │                  └────┬─────┘                 │       
           │                        │                       │     create     ┌─────────────┐
           │                        │                       │ ──────────────>│UpdateSiteURL│
           │                        │                       │                └──────┬──────┘
           │                    setURL                      │                       │       
           │───────────────────────────────────────────────>│                       │       
           │                        │                       │                       │       
           │                        │                       │     setDefaultURL     │       
           │                        │                       │ ─────────────────────>│       
           │                        │                       │                       │       
           │                    getURL                      │                       │       
           │───────────────────────────────────────────────>│                       │       
           │                        │                       │                       │       
           │                        │                       │     getDefaultURL     │       
           │                        │                       │ ─────────────────────>│       
           │                        │                       │                       │       
           │                        │     defaultURL        │                       │       
           │<─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─│       
     ┌─────┴─────┐          ┌───────┴───────┐          ┌────┴─────┐          ┌──────┴──────┐
     │SitesDialog│          │FilesCollection│          │UpdateSite│          │UpdateSiteURL│
     └───────────┘          └───────────────┘          └──────────┘          └─────────────┘

</source>


== Relevant PRs / issues ==
* [https://github.com/imagej/imagej-updater/issues/70 Issue for new updater]
* [https://github.com/imagej/imagej-updater/issues/66 Update cached update site links issue]
* [https://github.com/imagej/imagej-updater/pull/67 Support redirects PR] 
* [https://github.com/imagej/imagej-updater/pull/71 V1 imagej-updater PR]
* [https://github.com/imagej/imagej-ui-swing/pull/81 V1 imagej-swing-ui PR]
* [https://github.com/imagej/imagej-plugins-uploader-webdav/pull/3 V1 imagej-plugins-uploader-webdav PR]
