{{Infobox
| name                  = spim_viewer
| software              = Fiji
| author                = [[User:Pietzsch|TobiasPietzsch]]
| maintainer            = [mailto:pietzsch@mpi-cbg.de Tobias Pietzsch]
| source                = {{GitHub|org=tpietzsch|repo=spimviewer}}
<!-- | released              = January 5<sup>th</sup>, 2014 -->
| status                = beta
| category              = [[:Category:Visualization|Visualization]], [[:Category:Transform|Transform]]
}}

__TOC__

== Description ==
The BigDataViewer is a re-slicing browser for terabyte-sized multi-view image sequences.
BigDataViewer was developed with multi-view light-sheet microscopy data in mind and integrates well with Fiji's SPIMage processing pipeline.

Conceptually, the visualized data comprises multiple ''data sources''.
Each source provides one 3D image (for each time-point in the case of a time-lapse sequence).
For example, in a multi-angle SPIM sequence, each angle is a source.
In a multi-angle, multi-channel SPIM sequence, each channel of each angle is a source.

BigDataViewer comes with a custom data format that is is optimized for fast random access to very large data sets.
This permits browsing to any location within a multi-terabyte recording in a fraction of a second.

The file format is based on XML and HDF5.
Images are represented as tiled multi-resolution pyramids, and stored in HDF5 chunked multi-dimensional arrays.
The XML file contains metadata, for example the registration of sources to the global coordinate system.

== Installation ==
To get BigDataViewer you need to enable its update site in the Fiji Updater.
Select ''Help > Update Fiji'' from the Fiji menu to start the updater.

[[Image:bdv-imagej-updater-1.png|500px]]

Click on ''Manage update sites''. This brings up a dialog where you can activate additional update sites.

[[Image:bdv-manage-update-sites-1.png|500px]]

Activate the BigDataViewer update site and ''Close'' the dialog.
Now you should see additional files appearing for download.

[[Image:bdv-imagej-updater-2.png|500px]]

Click ''Apply changes'' and restart Fiji.

You should now have a sub-menu ''Plugins > BigDataViewer''.

== Usage ==
To use the BigDataViewer we need some example dataset to browse.
You can download a small dataset from
[http://fly.mpi-cbg.de/~pietzsch/bdv-example/ here], comprising two views and three time-points.
This is an excerpt of a 6 angle 715 time-point sequence of ''drosophila melanogaster'' embryonal development, imaged with a Zeiss Lightsheet Z.1.
Download both the XML and the HDF5 file and place them somewhere next to each other.

Alternatively, you can create a dataset by exporting your own data as described below.

=== Opening Dataset ===
To start BigDataViewer, select ''Plugins > BigDataViewer > Open XML/HDF5'' from the Fiji menu.
This brings up a file open dialog. Open the XML file of your test dataset.

=== Basic Navigation ===
You should see something like this:

[[Image:bdv-bdv-start.png]]

On startup, the middle slice of the first source (angle) is shown.
You can browse the stack using the keyboard or the mouse.
To get started, try the following:
* Use the mouse-wheel or {{key press|<}} and {{key press|>}} keys to scroll through z slices.
* {{key press|right-click|drag}} anywhere on the canvas to translate the image.
* Use {{key press|Ctrl|Shift|mouse-wheel}}, or {{key press|Up}} and {{key press|Down}} keys to zoom in and out.
* {{key press|left-click|drag}} anywhere on the canvas to rotate (reslice) the image.


The following table shows the available navigation commands using the mouse:

{| border="1" style="border-collapse:collapse;"
| style="padding: 5px;" | {{key press|left-click|drag}}
| style="padding: 5px;" | Rotate (pan and tilt) around the point where the mouse was clicked.
|-
| style="padding: 5px;" | {{key press|right-click|drag}} or {{key press|middle-click|drag}}
| style="padding: 5px;" | Translate in the XY-plane.
|-
| style="padding: 5px;" | {{key press|mouse-wheel}}
| style="padding: 5px;" | Move along the z-axis.
|-
| style="padding: 5px;" | {{key press|Cmd|mouse-wheel}} or {{key press|Shift|Ctrl|mouse-wheel}}
| style="padding: 5px;" | Zoom in and out.
|}


The following table shows the available navigation commands using keyboard shortcuts:
{| border="1" style="border-collapse:collapse;"
| style="padding: 5px;" | {{key press|X}}, {{key press|Y}}, {{key press|Z}}
| style="padding: 5px;" | Select keyboard rotation axis.
|-
| style="padding: 5px;" | {{key press|Left}}, {{key press|Right}}
| style="padding: 5px;" | Rotate clockwise or counter-clockwise around the choosen rotation axis.
|-
| style="padding: 5px;" | {{key press|Up}}, {{key press|Down}}
| style="padding: 5px;" | Zoom in or out.
|-
| style="padding: 5px;" | {{key press|,}}, {{key press|.}}
| style="padding: 5px;" | Move forward or backward along the Z-axis.
|-
| style="padding: 5px;" | {{key press|Shift|X}}
| style="padding: 5px;" | Rotate to the ZY-plane of the current source. (Look along the X-axis of the current source.)
|-
| style="padding: 5px;" | {{key press|Shift|Y}} or {{key press|Shift|A}}
| style="padding: 5px;" | Rotate to the XZ-plane of the current source. (Look along the Y-axis of the current source.)
|-
| style="padding: 5px;" | {{key press|Shift|Z}}
| style="padding: 5px;" | Rotate to the XY-plane of the current source. (Look along the Z-axis of the current source.)
|-
| style="padding: 5px;" | {{key press|[}} or {{key press|N}}
| style="padding: 5px;" | Move to previous timepoint.
|-
| style="padding: 5px;" | {{key press|]}} or {{key press|M}}
| style="padding: 5px;" | Move to next timepoint.
|}


For all navigation commands you can hold {{key press|Shift}} to rotate and browse
10x faster, or hold {{key press|Ctrl}} to rotate and browse
10x slower.
For example, {{key press|Left}} rotates by
1° clockwise, while {{key press|Shift|Left}} rotates by
10°, and {{key press|Ctrl|Left}} rotates by
0.1°.

=== Interpolation Mode ===
Using {{key press|I}} you can switch between nearest-neighbor and trilinear interpolation schemes.
The difference is clearly visible when you zoom in such that individual source pixels are visible.

[[Image:bdv-interpolation.png]]

Trilinear interpolation results in smoother images but is a bit more expensive computationally.
Nearest-neighbor is faster but looks more pixelated.

=== Displaying Multiple Sources ===
BigDataViewer datasets typically contain more than one source.
For a SPIM sequence one usually has multiple angles and possibly fused and deconvoled data on top.

Select ''Settings > Visibility & Grouping'' from the BigDataViewer menu to bring up a dialog to control source visibility.
You can also bring up this dialog by the shortcut {{key press|F6}}.

[[Image:bdv-visibility.png|500px]]

Using the current source checkboxes (A in the figure above), you can switch between available sources.
The first ten sources can also be made current by the number keys {{key press|1}} through {{key press|0}} in the main BigDataViewer window.

To view multiple sources overlaid at the same time, switch to ''fused mode'' using the checkbox (B).
You can also switch between normal and fused mode using the shortcut {{key press|F}} in the main window.
In fused mode individual sources can be turned on and off using the checkboxes (C) or shortcuts {{key press|Shift|1}} through {{key press|Shift|0}} in the main window.

Whether in normal or fused mode, the (unselectable) boxes (D) provide feedback on which sources are actually currently displayed.
Also the main window provides feedback:

[[Image:bdv-overlays-1.png|500px]]

In the top-left corner an overview of the dataset is displayed (E).
Visible sources are displayed as green/magenta wireframe boxes, invisible sources are displayed as grey wireframe boxes.
The dimensions of the boxes illustrate the size of the source images. The filled grey rectangle illustrates the screen area, i.e., the portion of the currently displayed slice.
For the visible sources, the part that is in front of the screen is green, the part that is behind the screen is magenta.

At the top of the window, the name of the current source is shown (F).

Note, that also in fused mode there is always a ''current source'', although this source may not even be visible.
Commands such as {{key press|Shift|X}} (rotate to ZY-plane) refer to the local coordinate system of the current source.

=== Grouping Sources ===
Often there are sets of sources for which visibility is logically related.
For example, in a multi-angle, multi-channel SPIM sequence, you will frequently want to see all channels of a given angle, or all angles of a given channel.
If your dataset contains deconvolved data, you may want to see either all raw angles overlaid, or the deconvolved view, respectively.
You want to be able to quickly switch between those two views.
Turning individual sources on and off becomes tedious in these situations.
Therefore, sources can be organized into ''groups''.
All sources of a ''group'' can be activated or deactivated at once.

Source grouping is handled in the visibility and grouping dialog, too
(menu ''Settings > Visibility & Grouping'' or shortcut {{key press|F6}}).

[[Image:bdv-grouping.png|500px]]

The lower half of the dialog is dedicated to grouping.
There are 10 groups available.
They are named "group 1" through "group 10" initially, but the names can be edited (A).

Sources can be assigned to groups using the checkboxes (B).
In every line, there are as many checkboxes as there are sources.
Sources corresponding to active checkboxes are assigned to the respective group.
For example, in the above screenshot there are two sources and therefore two "assigned sources" checkboxes per line
The first source is assigned to groups 1 and 2, the second source is assigned to groups 2 and 3.
Group 2 has been renamed to "all sources".

''Grouping'' can be turned on and off by the checkbox (C) or by using the shortcut {{key press|G}} in the main window.
If grouping is enabled, groups take the role of individual sources:
There is one ''current group'' which is visible in normal mode (all individual sources that are part of this group are overlaid).
Groups can be activated or deactivated to determine visibility in fused mode (all individual sources that are part of at least one active group are overlaid).

Groups can be made current and made active or inactive using the checkboxes (D).
Also, if grouping is enabled the number key shortcuts in the main BigDataViewer window act on groups instead of individual sources.
That is, groups 1 through 10 can be made current by keys {{key press|1}} through {{key press|0}}.
Similarly, shortcuts {{key press|Shift|1}} through {{key press|Shift|0}} in the main window activate or deactivate groups 1 through 10 for visibility in fused mode.

If grouping is enabled, the name of the current group is shown at the top of the main window.

[[Image:bdv-overlays-2.png|500px]]

=== Adjusting Brightness and Color ===
To change the brightness, contrast, or color of particular sources select ''Setting > Brightness & Color'' or press the shortcut {{key press|S}}.
This brings up the brightness and color settings dialog.

[[Image:bdv-brightness-1.png|500px]]

The ''min'' and ''max'' sliders (A) can be used to adjust the brightness and contrast.
They represent minimum and maximum source values that are mapped to the display range.
For the screenshot above, this means that source intensity 200 (and everything below) is mapped to black. Source intensity 862 (and everything above) is mapped to white.

When a new dataset is opened, BigDataViewer tries to estimate good initial ''min'' and ''max'' settings by looking at the first image of the dataset.

BigDataViewer datasets are currently always stored with 16 bits per pixel, however the data does not always exploit the full value range 0 ... 65535.
The example drosophila dataset uses values in the range of perhaps 0 ... 1000, except for the much brighter fiducial beads around the specimen.
The ''min'' and ''max'' sliders in this case are a bit fiddly to use, because they span the full 16 bit range with the interesting region squeezed into the first few pixels.
This can be remedied by adjusting the range of the sliders.
For this, click on the >> dialog button (B).
This shows two additional input fields, where the range of the sliders can be adjusted.
In the following screenshot, the leftmost value of the slider range has been set to 0 and the rightmost value to 2000, making the sliders much more useful.

[[Image:bdv-brightness-2.png|500px]]

So far, all sources share the same ''min'' and ''max'' settings.
However, these can also be adjusted for each individual source or for groups of sources.
The checkboxes (C) assign sources to ''min-max-groups''.
There is one checkbox per source.
In the example drosophila dataset there are two sources, therefore there are two checkboxes.
The active checkboxes indicate for which sources the ''min'' and ''max'' values apply.

If you uncheck one of the sources, it will move to its own new ''min-max-group''.
Now you can adjust the values for each source individually.
The sliders of new group are initialized as a copy of the old group.

[[Image:bdv-brightness-3.png|500px]]

Sources can be assigned to ''min-max-groups'' by checking/unchecking the checkboxes.
The rule is that every source is always assigned to exactly one min-max-group.
Thus, if you activate an unchecked source in a min-max-group, this will remove the source from its previous min-max-group and add it to the new one.
Unchecking a source will remove it from its min-max-group and move it to a new one.
Min-max-groups that become empty are removed.
To go back to a single min-max-group in the example, you would simply move all sources to the same group.

Finally, at the bottom of the dialog (D) colors can be assigned to sources.
There is one color button per source (two in the example).
Clicking a button brings up a color dialog, where you can choose a color for that particular source.
In the following screenshot, the sources have been colored magenta and green.

[[Image:bdv-brightness-4.png|500px]]

=== Loading and Saving Settings ===
Organizing sources into groups, assigning appropriate colors, and adjusting brightness correctly is work that you do not want to repeat over and over every time you re-open a dataset.
Therefore, BigDataViewer allows to save and load these settings.

Select ''File > Save settings'' from the menu to store settings to an XML file, and ''File > Load settings'' to load them from an XML file.

When a dataset is opened, BigDataViewer automatically loads an appropriately named settings file if it is present.
This settings file must be in the same directory as the dataset's XML file, and have the same filename with ''.settings'' appended.
For example, if the dataset's XML file is named ''drosophila.xml'', the settings file must be named ''drosophila.settings.xml''.
(If you select ''File > Save settings'', this filename is already suggested in the Save File dialog.)

Settings files assume that a specific number of sources are present, therefore settings are usually not compatible across different datasets.

=== Opening BigDataViewer Datasets as ImageJ Stacks ===
BigDataViewer may be great for looking at your data, but what if you want to apply other ImageJ algorithms or plugins to the images?
You can open individual images from a dataset as ImageJ stacks using ''File > Import > BigDataViewer...'' from the Fiji menu.

[[Image:bdv-import.png|500px]]

Select the XML file of a dataset, then choose the time-point and source (setup) index of the image you want to open.

Note that this import function is macro-recordable.
Thus, you can make use of it to batch-process images from BigDataViewer datasets.


== Exporting Datasets for the BigDataViewer ==
