{{Infobox
| software               = ImageJ
| name                   = FLIMJ plugin
| logo                     = [[File:Slim-curve-icon.png|64px]]
| author                 = [http://www.rob.ox.ac.uk/ CRUK/MRC at University of Oxford]<br/>[http://loci.wisc.edu/ UW-Madison LOCI]
| maintainer             = {{Person|Rueden}}
| filename               = flimlib.jar, flimlib-''arch''-''ver''.jar, <br> flimj-ops-''ver''.jar
| source                 = {{GitHub|org=slim-curve|repo=slim-plugin}}
| latest version         = 1.0.0
| website                = https://flimlib.github.io/
| category               = [[:Category:Analysis]]
}}

== Introduction ==
The FLIMJ plugin for ImageJ provides the ability to analyze FLIM data within ImageJ, using the [https://flimlib.github.io/ FLIMLib] library. The plugin can be installed into the [[Fiji]] distribution of ImageJ simply by enabling the FLIMJ [[update site]]. Features include:

* Fit individual pixels, entire images per-pixel, or do global analysis on entire images, using FLIMLib's rapid lifetime determination (RLD), Levenberg-Marquardt (LMA) or global analysis (Global) fitting algorithms
* Single, double and triple exponential fits
* Gaussian, Poisson and Maximum Likelihood Estimation noise models
* Produce one or several fitted images depending which parameters (A, τ, Z, χ²) are chosen for visualization
* Full control over the start and end fit cutoffs known as "cursors"
* Binning options for various kernel sizes to reduce noise and boost intensity when fitting per-pixel
* Support for so-called "excitation" or "prompt" files containing a recorded system response function to be convolved with the exponential fit
* Batch processing support for analyzing many lifetime images as part of a [[scripting]] workflow

== Installation ==

The FLIMJ plugin is available from the "FLIMJ" [[update site]].

Once you have installed the FLIMJ plugin, it becomes available on the menu under {{bc | Analyze | Lifetime | FLIMJ}}.

== Usage ==

=== Startup ===

Open a dataset (such as {{GitHub|org=flimlib|repo=flimj-ops|path=test_files/test2.sdt|label=this one}}) or select an existing image display in Fiji:

[[File:FLIMJ_usage_open_dataset.png|300px]]

With the desired dataset window active, launch FLIMJ from the menu under {{bc | Analyze | Lifetime | FLIMJ}} or search for "FLIMJ" in the search box:

[[File:FLIMJ_first_launch.png|600px]]

{{Notice | '''FLIMJ plugin accepts only 3- or 4-dimensional datasets.''' If the dataset is opened from a file supported by [[SCIFIO]] (such as a .sdt), the dataset likely has metadata attached, which helps FLIM plugin infer the order of the X, Y, and T axes as well as the time bin size. Otherwise, the user may be asked to provide the information:

[[File:FLIMJ_Lifetime_Axis_Not_Detected.png|350px]][[File:FLIMJ_Time_Base_Info_Not_Detected.png|200px]]

If the dataset comes with a (fourth) spectral dimension, the user has to choose the spectral channel to analyze as well:

[[File:FLIMJ_Multiple_Channel_Detected.png|350px]]
}}

=== Fit preview ===

Before fitting the entire dataset, the user may click on the intensity image or type in the coordinates in '''Preview''' panel to preview the fitted curve and parameters of the pixel under the cursor:

[[File:FLIMJ_preview_preview.png|200px]]
[[File:FLIMJ_preview_plot.png|400px]]
[[File:FLIMJ_preview_settings.png|200px]]

In the screenshots above,
* '''X''' and '''Y''' are coordinates of the pixel cursor counting from the upper left corner.
* '''Red curve''' denotes the fitted portion of decay between the start and end cursor.
* '''Orange dots''' denote the photon counts in each time bin in Fit plot and denote the residual (<math>y_{data}-y_{fit}</math>) in Res plot.
* '''Photon Count''' displays the total number of photons collected between the start and end cursor.
* <math>z, A, \tau</math> (or <math>z_1, A_1, A_2, \tau_1, \tau_2</math> in two-component fit) are the background, initial intensity and lifetime parameters of the model.
* <math>\chi^2</math> shows the chi-squared measure of the fit (see [[#Noise models|Noise models]]).

=== Fit settings ===

[[File:FLIMJ_fit_settings.png|200px|thumb|right|Options on the '''Settings''' pannel.]]

Sometimes you may want to fine-tune the fitting configurations. The '''Settings''' panel and the '''Plot''' pannel. The configurations include:

* '''Intensity Thresh.''': The minimal pixel intensity to be fitted.<br/>Any pixel with cumulative intensity (over all time bins) below this threshold will be skipped when the dataset is fitted. When selected for preview in the '''Preview''' panel, only the photon counts (orange dots) will be plotted. ''For those pixels, all parameters are treated as 0 both when being previewed and when the whole dataset is fitted.''

* '''Kernel Size''': The radius (in pixels, excluding the center) of the binning kernel.<br/>FLIMJ plugin currently only supports the square kernel with size <math>2r+1</math> and values all equal to 1 where <math>r</math> is the radius). The binning of the dataset is performed by convolving the dataset with this kernel, which is equivalent to adding neighboring pixels into the center:
[[File:FLIMJ_settings_binning.png|600px|thumb|center|Left to right: Intensity of dataset after binning of radius 0, 1, and 2.]]

* '''χ² Target''': The <math>\chi^2</math> value below which the LM fitting will stop.<br/>The LM algorithm checks at the end of each iteration whether the fit is good enough by comparing <math>\chi^2</math> with this threshold. If the results are satisfactory, the LM algorithm will terminate.

* '''Noise Model''': The noise model used for fitting (see [[#Noise models|Noise models]]).

* '''Algorithm''': The algorithm used for fitting.<br/>Currently supported algorithms are:
** '''LMA''': The Levenberg-Marquardt algorithm;
** '''Global''': The global LMA algorithm;
** '''Bayes''': The Bayesian fitting algorithm.

* '''Instrument Response''': The dataset that contains the instrument response. (see [[#Instrument response function (IRF/prompt)|Instrument response function (IRF/prompt)]]).

* '''# of Components''': The number of exponential decay terms in the model.<br/>FLIMJ plugin currently supports up to 3 components.

* '''Start''' and '''End''': The ends (in ns, inclusive) of the interval during which the data is considered.<br/>The cursors can be changed by dragging in the Fit plot, clicking on the up and down buttons, or typing in values (input will be rounded to the nearest time bin marking).
[[File:FLIMJ_settings_start_end.png|700px|thumb|center|Change of the cursors results in different fit results.]]

==== Instrument response function (IRF/prompt) ====

More documentation coming soon. For now, see the source code at:

{{BigLink | url=https://github.com/flimlib/flimj-ui}}

And:

{{BigLink | url=https://github.com/flimlib/flimj-ops}}

== Advanced topics ==

=== Noise models ===
Coming soon...
